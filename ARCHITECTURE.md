# 架構說明 (Architecture)

本專案採用「三層式火箭推進模型」，旨在徹底分離使用者介面 (UI)、啟動邏輯和核心應用程式，確保各層職責單一、清晰且易於維護。

```mermaid
graph TD
    subgraph 駕駛艙 (Colab Notebook)
        A[使用者參數輸入<br>@param form]
    end

    subgraph 點火器 (Ignition)
        B(colab_run.py)
    end

    subgraph 主引擎 (Main Engine)
        C(colab_bootstrap.py)
    end

    subgraph 核心應用 (Core Application)
        D(run.py)
        E[FastAPI 伺服器]
        F[應用程式邏輯<br>(e.g., apps/transcriber)]
    end

    A -- 傳遞參數 --> B;
    B -- 執行並傳遞參數 --> C;
    C -- 啟動並監控 --> D;
    D -- 載入並執行 --> F;
    D -- 啟動 --> E;
    C -- 渲染 UI & IFrame --> A;
    E -- 透過 IFrame 呈現 --> A;
```

---

## 組件職責詳解

### 1. **駕駛艙 (Colab Notebook)**
- **檔案**: `*.ipynb`
- **職責**:
    - **唯一的參數輸入點**：提供一個基於 `@param` 的表單，讓使用者可以直觀地設定所有可配置的選項（如：資料夾路徑、顯示偏好、伺服器埠號等）。
    - **使用者互動介面**：作為最終使用者與整個系統互動的唯一窗口。
    - **極簡化**: 除了參數定義和啟動「點火器」的程式碼外，不包含任何複雜邏輯。

### 2. **點火器 (Ignition - `colab_run.py`)**
- **檔案**: `colab_run.py`
- **職責**:
    - **參數傳遞者**：其唯一職責是從 Colab Notebook 的全域變數中接收參數。
    - **啟動主引擎**：將接收到的參數序列化為命令列參數，並用它們來執行 `colab_bootstrap.py`。
    - **輕量級**: 不包含任何業務邏輯、UI 渲染或進程管理。它是一個單純的、一次性的啟動腳本。

### 3. **主引擎 (Main Engine - `colab_bootstrap.py`)**
- **檔案**: `colab_bootstrap.py`
- **職責**:
    - **整合式指揮中心**: 負責在 Colab 的輸出中渲染一個包含即時日誌、系統狀態 (CPU/RAM) 和應用程式 IFrame 的動態介面。
    - **流程協調**：按照預定順序執行關鍵任務，包括：
        1. 安裝依賴 (`uv_manager.py`)。
        2. 啟動後端伺服器 (`run.py`)。
    - **生命週期管理**：
        - 監控後端伺服器進程的健康狀況，並在其意外終止時發出警報。
        - 透過 `atexit` 和 `psutil` 確保在腳本正常或異常退出時，所有衍生的子進程都能被徹底清理。
    - **日誌管理**:
        - 捕獲所有子進程的 `stdout` 和 `stderr`。
        - 將格式化後的日誌即時顯示在 UI 上。
        - 在任務結束時，將完整的日誌歸檔到指定的資料夾中。

### 4. **核心應用 (Core Application)**
- **檔案**: `run.py`, `main.py`, `apps/*`
- **職責**:
    - **啟動器 (`run.py`)**: 一個簡單的 FastAPI 啟動腳本，根據傳入的參數（應用程式目錄、埠號）來啟動 uvicorn 伺服器。
    - **主應用 (`main.py`)**: 包含 FastAPI 應用實例，負責路由和載入來自 `apps` 目錄的具體應用邏輯。
    - **業務邏輯 (`apps/**/*.py`)**: 包含所有實際的業務邏輯，例如語音轉錄、資料分析等。這一層與 Colab 環境完全解耦，可以獨立開發和測試。
---

這種分層設計帶來了以下優勢：

- **高度解耦**：UI、啟動腳本和核心邏輯可以獨立修改和演進。
- **易於除錯**：問題可以被快速定位到具體的層級。
- **職責清晰**：每個腳本都有一個明確、單一的目標。
- **提升使用者體驗**：將複雜的後端流程抽象為一個互動式的、資訊豐富的指揮中心介面，使用者無需關心底層細節。
