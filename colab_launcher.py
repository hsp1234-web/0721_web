# -*- coding: utf-8 -*-
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                                 â•‘
# â•‘   ğŸš€ é³³å‡°ä¹‹å¿ƒ Colab æ•´åˆå•Ÿå‹•å™¨ v3 (ç¹ä¸­çµ‚æ¥µç‰ˆ)                                  â•‘
# â•‘                                                                                 â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘                                                                                 â•‘
# â•‘   v3 æ›´æ–° (Jules å…¨é¢å‡ç´š):                                                     â•‘
# â•‘       - **æ¥µè‡´ä¸­æ–‡é«”é©—**: æ‰€æœ‰åƒæ•¸ã€æ—¥èªŒã€èªªæ˜å‡æ¡ç”¨ç¹é«”ä¸­æ–‡ï¼Œæ¸…æ™°æ˜“æ‡‚ã€‚        â•‘
# â•‘       - **æ™ºæ…§æ—¥èªŒæ­¸æª”**: è‡ªå‹•å°‡æ¯æ¬¡é‹è¡Œçš„å®Œæ•´æ—¥èªŒï¼ŒåŒ…å«æ•ˆèƒ½åˆ†æï¼Œå­˜æª”ç‚º .mdã€‚  â•‘
# â•‘       - **æ•ˆèƒ½ç“¶é ¸åˆ†æ**: åœ¨æ­¸æª”æ—¥èªŒä¸­è‡ªå‹•ç”Ÿæˆå„éšæ®µè€—æ™‚å ±å‘Šï¼Œç“¶é ¸ä¸€ç›®äº†ç„¶ã€‚    â•‘
# â•‘       - **ç¶²å€è‡ªå‹•æ•æ‰**: åŸ·è¡Œå¾Œè‡ªå‹•æƒææœå‹™æ—¥èªŒï¼Œæ•ç²ä¸¦é¡¯ç¤º ngrok ç­‰å…¬ç¶²ç¶²å€ã€‚ â•‘
# â•‘       - **æ•´åˆ Git æµç¨‹**: å…§å»ºå¾é›¶åˆ°ä¸€çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…å«ä¸‹è¼‰ç¨‹å¼ç¢¼ã€‚             â•‘
# â•‘                                                                                 â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ====================================================================================
# Part 1: åƒæ•¸è¨­å®šå€ (è«‹åœ¨æ­¤è™•å®Œæˆæ‰€æœ‰è¨­å®š)
# ====================================================================================
#@title ğŸ’ é³³å‡°ä¹‹å¿ƒæŒ‡æ®ä¸­å¿ƒ (v3 ç¹ä¸­çµ‚æ¥µç‰ˆ) { vertical-output: true, display-mode: "form" }

#@markdown ---
#@markdown ### **ä¸€ã€åŸå§‹ç¢¼è¨­å®š**
#@markdown > **è¨­å®š Git å€‰åº«ä½å€ã€è¦ä½¿ç”¨çš„ç‰ˆæœ¬ (åˆ†æ”¯æˆ–æ¨™ç±¤)ï¼Œä»¥åŠå°ˆæ¡ˆåœ¨ Colab ä¸­çš„è³‡æ–™å¤¾åç¨±ã€‚**
#@markdown ---
ç¨‹å¼ç¢¼å€‰åº«ç¶²å€ = "https://github.com/hsp1234-web/0721_web" #@param {type:"string"}
è¦ä½¿ç”¨çš„ç‰ˆæœ¬åˆ†æ”¯æˆ–æ¨™ç±¤ = "main" #@param {type:"string"}
å°ˆæ¡ˆè³‡æ–™å¤¾åç¨± = "phoenix_project_v3" #@param {type:"string"}
#@markdown **å¼·åˆ¶åˆ·æ–°å¾Œç«¯ç¨‹å¼ç¢¼**
#@markdown >å‹¾é¸æ­¤é …æœƒåœ¨æœ¬æ©Ÿåˆªé™¤èˆŠçš„å°ˆæ¡ˆè³‡æ–™å¤¾ï¼Œä¸¦å¾ Git é‡æ–°ä¸‹è¼‰ã€‚
æ˜¯å¦å¼·åˆ¶åˆ·æ–°ç¨‹å¼ç¢¼ = True #@param {type:"boolean"}

#@markdown ---
#@markdown ### **äºŒã€å®‰è£èˆ‡å•Ÿå‹•è¨­å®š**
#@markdown > **é¸æ“‡å®‰è£æ¨¡å¼ï¼Œä¸¦ç‚ºæ¯å€‹å¾®æœå‹™æ‡‰ç”¨æŒ‡å®šå•Ÿå‹•çš„åŸ è™Ÿã€‚**
#@markdown ---
å®‰è£æ¨¡å¼ = "æ¨¡æ“¬å®‰è£ (åƒ…æ ¸å¿ƒä¾è³´)" #@param ["å®Œæ•´å®‰è£ (åŒ…å«å¤§å‹ä¾è³´)", "æ¨¡æ“¬å®‰è£ (åƒ…æ ¸å¿ƒä¾è³´)"]
é‡åŒ–åˆ†ææœå‹™åŸ è™Ÿ = 8001 #@param {type:"integer"}
èªéŸ³è½‰å¯«æœå‹™åŸ è™Ÿ = 8002 #@param {type:"integer"}

#@markdown ---
#@markdown ### **ä¸‰ã€æ—¥èªŒèˆ‡æ™‚å€è¨­å®š**
#@markdown > **è¨­å®šæ—¥èªŒæ­¸æª”è³‡æ–™å¤¾åç¨±å’Œç³»çµ±æ™‚å€ã€‚**
#@markdown ---
#@markdown **ä½œæˆ°æ—¥èªŒæ­¸æª”è³‡æ–™å¤¾**
#@markdown > æ‰€æœ‰æœ¬æ¬¡åŸ·è¡Œçš„è©³ç´°éç¨‹ï¼ŒåŒ…å«æ•ˆèƒ½åˆ†æï¼Œéƒ½æœƒå­˜æª”æ–¼æ­¤ã€‚ç•™ç©ºå‰‡é—œé–‰æ­¤åŠŸèƒ½ã€‚
æ—¥èªŒæ­¸æª”è³‡æ–™å¤¾ = "ä½œæˆ°æ—¥èªŒ" #@param {type:"string"}
æ™‚å€ = "Asia/Taipei" #@param {type:"string"}

# ====================================================================================
# Part 2: æ ¸å¿ƒå•Ÿå‹•é‚è¼¯ (é€šå¸¸ç„¡éœ€ä¿®æ”¹)
# ====================================================================================
import os
import sys
import subprocess
import shlex
import shutil
from pathlib import Path
import time
import re
from datetime import datetime
from IPython.display import display, Markdown

# --- å…¨åŸŸè¨­å®šèˆ‡è¼”åŠ©é¡åˆ¥ ---
class è‰²å½©:
    æ¨™é¡Œ = '\033[95m'
    æˆåŠŸ = '\033[92m'
    è­¦å‘Š = '\033[93m'
    å¤±æ•— = '\033[91m'
    çµæŸ = '\033[0m'
    ç²—é«” = '\033[1m'

class è¨ˆæ™‚å™¨:
    def __init__(self):
        self.ç´€éŒ„ = [("å•Ÿå‹•", time.time())]
    def æ¨™è¨˜(self, åç¨±):
        self.ç´€éŒ„.append((åç¨±, time.time()))
    def ç”¢ç”Ÿå ±å‘Š(self):
        å ±å‘Š = "### â±ï¸ æ•ˆèƒ½åˆ†ææ‘˜è¦\n\n| éšæ®µ | è€—æ™‚ (ç§’) |\n| :--- | :--- |\n"
        for i in range(1, len(self.ç´€éŒ„)):
            éšæ®µåç¨± = self.ç´€éŒ„[i-1][0]
            è€—æ™‚ = self.ç´€éŒ„[i][1] - self.ç´€éŒ„[i-1][1]
            å ±å‘Š += f"| {éšæ®µåç¨±} | {è€—æ™‚:.2f} |\n"
        ç¸½è€—æ™‚ = self.ç´€éŒ„[-1][1] - self.ç´€éŒ„[0][1]
        å ±å‘Š += f"| **ç¸½è¨ˆ** | **{ç¸½è€—æ™‚:.2f}** |\n"
        return å ±å‘Š

# --- è¼”åŠ©å‡½æ•¸ ---
def å°å‡ºæ¨™é¡Œ(è¨Šæ¯): print(f"\n{è‰²å½©.æ¨™é¡Œ}{è‰²å½©.ç²—é«”}ğŸš€ {è¨Šæ¯} ğŸš€{è‰²å½©.çµæŸ}")
def å°å‡ºæˆåŠŸ(è¨Šæ¯): print(f"{è‰²å½©.æˆåŠŸ}âœ… {è¨Šæ¯}{è‰²å½©.çµæŸ}")
def å°å‡ºè­¦å‘Š(è¨Šæ¯): print(f"{è‰²å½©.è­¦å‘Š}âš ï¸ {è¨Šæ¯}{è‰²å½©.çµæŸ}")
def å°å‡ºè³‡è¨Š(è¨Šæ¯): print(f"â„¹ï¸ {è¨Šæ¯}")

def åŸ·è¡ŒæŒ‡ä»¤(æŒ‡ä»¤, å·¥ä½œç›®éŒ„, ç’°å¢ƒè®Šæ•¸=None):
    å°å‡ºè³‡è¨Š(f"åŸ·è¡Œä¸­: {è‰²å½©.ç²—é«”}{æŒ‡ä»¤}{è‰²å½©.çµæŸ}")
    ç›®å‰ç’°å¢ƒ = os.environ.copy()
    if ç’°å¢ƒè®Šæ•¸: ç›®å‰ç’°å¢ƒ.update(ç’°å¢ƒè®Šæ•¸)
    ç¨‹åº = subprocess.Popen(
        shlex.split(æŒ‡ä»¤), stdout=subprocess.PIPE, stderr=subprocess.STDOUT,
        cwd=å·¥ä½œç›®éŒ„, text=True, encoding='utf-8', errors='replace', env=ç›®å‰ç’°å¢ƒ
    )
    æ—¥èªŒè¼¸å‡º = []
    while True:
        è¼¸å‡º = ç¨‹åº.stdout.readline()
        if è¼¸å‡º == '' and ç¨‹åº.poll() is not None: break
        if è¼¸å‡º:
            ä¹¾æ·¨è¼¸å‡º = è¼¸å‡º.strip()
            print(f"   {ä¹¾æ·¨è¼¸å‡º}")
            æ—¥èªŒè¼¸å‡º.append(ä¹¾æ·¨è¼¸å‡º)
    è¿”å›ç¢¼ = ç¨‹åº.wait()
    return è¿”å›ç¢¼, æ—¥èªŒè¼¸å‡º

# --- ä¸»è¦åŠŸèƒ½å‡½æ•¸ ---
def æº–å‚™å°ˆæ¡ˆç¨‹å¼ç¢¼(åŸºç¤è·¯å¾‘, å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 1/4: æº–å‚™å°ˆæ¡ˆç¨‹å¼ç¢¼")
    if æ˜¯å¦å¼·åˆ¶åˆ·æ–°ç¨‹å¼ç¢¼ and å°ˆæ¡ˆè·¯å¾‘.exists():
        å°å‡ºè­¦å‘Š(f"åµæ¸¬åˆ°ã€Œå¼·åˆ¶åˆ·æ–°ã€ï¼Œæ­£åœ¨åˆªé™¤èˆŠè³‡æ–™å¤¾: {å°ˆæ¡ˆè·¯å¾‘}")
        shutil.rmtree(å°ˆæ¡ˆè·¯å¾‘)
        å°å‡ºæˆåŠŸ("èˆŠè³‡æ–™å¤¾å·²ç§»é™¤ã€‚")
    if not å°ˆæ¡ˆè·¯å¾‘.exists():
        å°å‡ºè³‡è¨Š(f"é–‹å§‹å¾ GitHub (ç‰ˆæœ¬: {è¦ä½¿ç”¨çš„ç‰ˆæœ¬åˆ†æ”¯æˆ–æ¨™ç±¤}) æ‹‰å–ç¨‹å¼ç¢¼...")
        æŒ‡ä»¤ = f"git clone -q --branch {è¦ä½¿ç”¨çš„ç‰ˆæœ¬åˆ†æ”¯æˆ–æ¨™ç±¤} --depth 1 {ç¨‹å¼ç¢¼å€‰åº«ç¶²å€} {å°ˆæ¡ˆè·¯å¾‘.name}"
        è¿”å›ç¢¼, _ = åŸ·è¡ŒæŒ‡ä»¤(æŒ‡ä»¤, cwd=åŸºç¤è·¯å¾‘)
        if è¿”å›ç¢¼ != 0:
            print(f"{è‰²å½©.å¤±æ•—}Git clone å¤±æ•—ï¼è«‹æª¢æŸ¥ URL å’Œåˆ†æ”¯/æ¨™ç±¤åç¨±ã€‚{è‰²å½©.çµæŸ}")
            return False
        å°å‡ºæˆåŠŸ("ç¨‹å¼ç¢¼æˆåŠŸä¸‹è¼‰ï¼")
    else:
        å°å‡ºæˆåŠŸ(f"è³‡æ–™å¤¾ '{å°ˆæ¡ˆè·¯å¾‘.name}' å·²å­˜åœ¨ï¼Œè·³éä¸‹è¼‰ã€‚")
    è¨ˆæ™‚.æ¨™è¨˜("æº–å‚™ä¾è³´ç’°å¢ƒ")
    return True

def æº–å‚™ä¾è³´ç’°å¢ƒ(å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 2/4: æº–å‚™ä¾è³´ç’°å¢ƒ (æ··åˆå¼)")
    æ‡‰ç”¨ç¨‹å¼ç›®éŒ„ = å°ˆæ¡ˆè·¯å¾‘ / "apps"
    è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„ = Path(f"/dev/shm/{å°ˆæ¡ˆè³‡æ–™å¤¾åç¨±}_venvs") if sys.platform == "linux" else å°ˆæ¡ˆè·¯å¾‘ / ".venvs"
    å¤§å‹ä¾è³´æ ¹ç›®éŒ„ = å°ˆæ¡ˆè·¯å¾‘ / ".large_packages"
    æ˜¯å¦å®‰è£å¤§å‹ä¾è³´ = "å®Œæ•´å®‰è£" in å®‰è£æ¨¡å¼

    try:
        subprocess.check_output(["uv", "--version"], stderr=subprocess.STDOUT)
    except (subprocess.CalledProcessError, FileNotFoundError):
        å°å‡ºè­¦å‘Š("uv æœªæ‰¾åˆ°ï¼Œæ­£åœ¨å¾ pip å®‰è£...")
        è¿”å›ç¢¼, _ = åŸ·è¡ŒæŒ‡ä»¤(f"{sys.executable} -m pip install -q uv", cwd=å°ˆæ¡ˆè·¯å¾‘)
        if è¿”å›ç¢¼ != 0: return False

    if è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„.exists(): shutil.rmtree(è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„)
    if å¤§å‹ä¾è³´æ ¹ç›®éŒ„.exists(): shutil.rmtree(å¤§å‹ä¾è³´æ ¹ç›®éŒ„)
    è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„.mkdir(parents=True, exist_ok=True)
    if æ˜¯å¦å®‰è£å¤§å‹ä¾è³´: å¤§å‹ä¾è³´æ ¹ç›®éŒ„.mkdir(parents=True, exist_ok=True)

    å°å‡ºè³‡è¨Š(f"è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„: {è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„}")
    if æ˜¯å¦å®‰è£å¤§å‹ä¾è³´: å°å‡ºè³‡è¨Š(f"å¤§å‹ä¾è³´ç›®éŒ„: {å¤§å‹ä¾è³´æ ¹ç›®éŒ„}")

    for æ‡‰ç”¨è·¯å¾‘ in (d for d in æ‡‰ç”¨ç¨‹å¼ç›®éŒ„.iterdir() if d.is_dir()):
        æ‡‰ç”¨åç¨± = æ‡‰ç”¨è·¯å¾‘.name
        å°å‡ºè³‡è¨Š(f"--- æ­£åœ¨æº–å‚™ App: {æ‡‰ç”¨åç¨±} ---")
        è™›æ“¬ç’°å¢ƒè·¯å¾‘ = è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„ / æ‡‰ç”¨åç¨±
        PythonåŸ·è¡Œæª” = è™›æ“¬ç’°å¢ƒè·¯å¾‘ / 'bin/python'

        è¿”å›ç¢¼, _ = åŸ·è¡ŒæŒ‡ä»¤(f"uv venv '{è™›æ“¬ç’°å¢ƒè·¯å¾‘}' --seed", cwd=å°ˆæ¡ˆè·¯å¾‘)
        if è¿”å›ç¢¼ != 0: return False

        éœ€æ±‚æª”æ¡ˆ = æ‡‰ç”¨è·¯å¾‘ / "requirements.txt"
        if éœ€æ±‚æª”æ¡ˆ.exists():
            è¿”å›ç¢¼, _ = åŸ·è¡ŒæŒ‡ä»¤(f"uv pip install --python '{PythonåŸ·è¡Œæª”}' -r '{éœ€æ±‚æª”æ¡ˆ}'", cwd=å°ˆæ¡ˆè·¯å¾‘)
            if è¿”å›ç¢¼ != 0: return False

        å¤§å‹éœ€æ±‚æª”æ¡ˆ = æ‡‰ç”¨è·¯å¾‘ / "requirements.large.txt"
        if æ˜¯å¦å®‰è£å¤§å‹ä¾è³´ and å¤§å‹éœ€æ±‚æª”æ¡ˆ.exists():
            ç›®æ¨™ç›®éŒ„ = å¤§å‹ä¾è³´æ ¹ç›®éŒ„ / æ‡‰ç”¨åç¨±
            ç›®æ¨™ç›®éŒ„.mkdir(exist_ok=True)
            è¿”å›ç¢¼, _ = åŸ·è¡ŒæŒ‡ä»¤(f"uv pip install --target '{ç›®æ¨™ç›®éŒ„}' -r '{å¤§å‹éœ€æ±‚æª”æ¡ˆ}'", cwd=å°ˆæ¡ˆè·¯å¾‘)
            if è¿”å›ç¢¼ != 0: return False

    å°å‡ºæˆåŠŸ("æ‰€æœ‰ App ç’°å¢ƒå‡å·²æº–å‚™å°±ç·’ï¼")
    è¨ˆæ™‚.æ¨™è¨˜("å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼")
    return True

def å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼(å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 3/4: å•Ÿå‹•æ‰€æœ‰æ‡‰ç”¨ç¨‹å¼")
    æ‡‰ç”¨ç¨‹å¼ç›®éŒ„ = å°ˆæ¡ˆè·¯å¾‘ / "apps"
    è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„ = Path(f"/dev/shm/{å°ˆæ¡ˆè³‡æ–™å¤¾åç¨±}_venvs") if sys.platform == "linux" else å°ˆæ¡ˆè·¯å¾‘ / ".venvs"
    å¤§å‹ä¾è³´æ ¹ç›®éŒ„ = å°ˆæ¡ˆè·¯å¾‘ / ".large_packages"
    æ˜¯å¦å®‰è£å¤§å‹ä¾è³´ = "å®Œæ•´å®‰è£" in å®‰è£æ¨¡å¼

    æ‡‰ç”¨åŸ è™Ÿ = {"quant": é‡åŒ–åˆ†ææœå‹™åŸ è™Ÿ, "transcriber": èªéŸ³è½‰å¯«æœå‹™åŸ è™Ÿ}
    å•Ÿå‹•çš„ç¨‹åº = []

    for æ‡‰ç”¨è·¯å¾‘ in (d for d in æ‡‰ç”¨ç¨‹å¼ç›®éŒ„.iterdir() if d.is_dir()):
        æ‡‰ç”¨åç¨± = æ‡‰ç”¨è·¯å¾‘.name
        åŸ è™Ÿ = æ‡‰ç”¨åŸ è™Ÿ.get(æ‡‰ç”¨åç¨±)
        if not åŸ è™Ÿ: continue

        å°å‡ºè³‡è¨Š(f"--- æ­£åœ¨å•Ÿå‹• App: {æ‡‰ç”¨åç¨±} (åŸ è™Ÿ: {åŸ è™Ÿ}) ---")
        è™›æ“¬ç’°å¢ƒè·¯å¾‘ = è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„ / æ‡‰ç”¨åç¨±
        PythonåŸ·è¡Œæª” = è™›æ“¬ç’°å¢ƒè·¯å¾‘ / 'bin/python'
        ä¸»ç¨‹å¼è·¯å¾‘ = æ‡‰ç”¨è·¯å¾‘ / "main.py"

        ç’°å¢ƒè®Šæ•¸ = os.environ.copy()
        Pythonè·¯å¾‘åˆ—è¡¨ = [str(å°ˆæ¡ˆè·¯å¾‘)]

        if æ˜¯å¦å®‰è£å¤§å‹ä¾è³´:
            å¤§å‹ä¾è³´è·¯å¾‘ = å¤§å‹ä¾è³´æ ¹ç›®éŒ„ / æ‡‰ç”¨åç¨±
            if å¤§å‹ä¾è³´è·¯å¾‘.exists(): Pythonè·¯å¾‘åˆ—è¡¨.append(str(å¤§å‹ä¾è³´è·¯å¾‘))

        Pythonç‰ˆæœ¬ç›®éŒ„ = next((è™›æ“¬ç’°å¢ƒè·¯å¾‘ / "lib").glob("python*"), None)
        if Pythonç‰ˆæœ¬ç›®éŒ„ and (Pythonç‰ˆæœ¬ç›®éŒ„ / "site-packages").exists():
            Pythonè·¯å¾‘åˆ—è¡¨.append(str(Pythonç‰ˆæœ¬ç›®éŒ„ / "site-packages"))

        ç’°å¢ƒè®Šæ•¸["PYTHONPATH"] = os.pathsep.join(Pythonè·¯å¾‘åˆ—è¡¨)
        ç’°å¢ƒè®Šæ•¸["PORT"] = str(åŸ è™Ÿ)
        ç’°å¢ƒè®Šæ•¸["TIMEZONE"] = æ™‚å€

        å°å‡ºè³‡è¨Š(f"ä½¿ç”¨ PYTHONPATH: {ç’°å¢ƒè®Šæ•¸['PYTHONPATH']}")

        æ—¥èªŒæª”æ¡ˆ = Path(f"/content/{æ‡‰ç”¨åç¨±}.log")
        å°å‡ºè³‡è¨Š(f"æ—¥èªŒå°‡è¼¸å‡ºåˆ°: {æ—¥èªŒæª”æ¡ˆ}")

        ç¨‹åº = subprocess.Popen(
            [str(PythonåŸ·è¡Œæª”), str(ä¸»ç¨‹å¼è·¯å¾‘)], env=ç’°å¢ƒè®Šæ•¸,
            stdout=æ—¥èªŒæª”æ¡ˆ.open('w'), stderr=subprocess.STDOUT
        )
        å•Ÿå‹•çš„ç¨‹åº.append(ç¨‹åº)
        å°å‡ºæˆåŠŸ(f"App '{æ‡‰ç”¨åç¨±}' å·²åœ¨èƒŒæ™¯å•Ÿå‹•ï¼ŒPID: {ç¨‹åº.pid}")

    è¨ˆæ™‚.æ¨™è¨˜("å®Œæˆå•Ÿå‹•èˆ‡æƒæ")
    return å•Ÿå‹•çš„ç¨‹åº

def æœ€çµ‚ç¸½çµèˆ‡ç¶²å€æƒæ(å•Ÿå‹•çš„ç¨‹åº, è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 4/4: ç³»çµ±ç‹€æ…‹ç¸½çµèˆ‡ç¶²å€æƒæ")
    print("ç­‰å¾…æœå‹™å•Ÿå‹•ä»¥æƒææ—¥èªŒ...")
    time.sleep(15) # çµ¦æœå‹™ (ç‰¹åˆ¥æ˜¯ ngrok) ä¸€é»æ™‚é–“å•Ÿå‹•å’Œå¯«å…¥æ—¥èªŒ

    å…¬é–‹ç¶²å€ = {}
    ç¶²å€æ­£å‰‡ = re.compile(r"https?://[a-zA-Z0-9\-]+\.ngrok-free\.app")

    for app_name in ["quant", "transcriber"]:
        æ—¥èªŒæª”æ¡ˆ = Path(f"/content/{app_name}.log")
        if æ—¥èªŒæª”æ¡ˆ.exists():
            content = æ—¥èªŒæª”æ¡ˆ.read_text()
            match = ç¶²å€æ­£å‰‡.search(content)
            if match:
                url = match.group(0)
                å…¬é–‹ç¶²å€[app_name] = url
                å°å‡ºæˆåŠŸ(f"åœ¨ '{app_name}' çš„æ—¥èªŒä¸­æ•ç²åˆ°ç¶²å€: {url}")

    display(Markdown("---"))
    ç¸½çµå ±å‘Š = f"### âœ… é³³å‡°ä¹‹å¿ƒç³»çµ±å·²æˆåŠŸå•Ÿå‹•ï¼\n\n"
    ç¸½çµå ±å‘Š += f"**ç¸½è€—æ™‚**: {è¨ˆæ™‚.ç´€éŒ„[-1][1] - è¨ˆæ™‚.ç´€éŒ„[0][1]:.2f} ç§’\n\n"
    ç¸½çµå ±å‘Š += f"**å„æœå‹™æ­£åœ¨èƒŒæ™¯é‹è¡Œä¸­ (PIDs: {', '.join(str(p.pid) for p in å•Ÿå‹•çš„ç¨‹åº)})**\n"
    ç¸½çµå ±å‘Š += f"- **é‡åŒ–åˆ†ææœå‹™**: `http://localhost:{é‡åŒ–åˆ†ææœå‹™åŸ è™Ÿ}`\n"
    if "quant" in å…¬é–‹ç¶²å€:
        ç¸½çµå ±å‘Š += f"  - ğŸŒ **å…¬ç¶²ç¶²å€**: [{å…¬é–‹ç¶²å€['quant']}]({å…¬é–‹ç¶²å€['quant']})\n"
    ç¸½çµå ±å‘Š += f"- **èªéŸ³è½‰å¯«æœå‹™**: `http://localhost:{èªéŸ³è½‰å¯«æœå‹™åŸ è™Ÿ}`\n"
    if "transcriber" in å…¬é–‹ç¶²å€:
        ç¸½çµå ±å‘Š += f"  - ğŸŒ **å…¬ç¶²ç¶²å€**: [{å…¬é–‹ç¶²å€['transcriber']}]({å…¬é–‹ç¶²å€['transcriber']})\n"

    ç¸½çµå ±å‘Š += f"\n> **æç¤º**: æ—¥èªŒæª”æ¡ˆä½æ–¼ `/content/quant.log` å’Œ `/content/transcriber.log`ã€‚\n"
    ç¸½çµå ±å‘Š += "> è‹¥è¦åœæ­¢æ‰€æœ‰æœå‹™ï¼Œè«‹é»æ“Š Colab ä¸Šæ–¹çš„ã€Œä¸­æ–·åŸ·è¡Œã€æŒ‰éˆ•ã€‚"

    display(Markdown(ç¸½çµå ±å‘Š))
    return ç¸½çµå ±å‘Š, è¨ˆæ™‚.ç”¢ç”Ÿå ±å‘Š()

# --- ä¸»åŸ·è¡Œæµç¨‹ ---
def main():
    è¨ˆæ™‚å™¨å¯¦ä¾‹ = è¨ˆæ™‚å™¨()

    # æ•ç²æ‰€æœ‰è¼¸å‡ºä»¥ä¾›æ­¸æª”
    from io import StringIO
    import sys
    èˆŠçš„_stdout = sys.stdout
    æ—¥èªŒä¸²æµ = StringIO()
    sys.stdout = æ—¥èªŒä¸²æµ

    try:
        from IPython.display import clear_output
        clear_output(wait=True)

        åŸºç¤è·¯å¾‘ = Path("/content")
        å°ˆæ¡ˆè·¯å¾‘ = åŸºç¤è·¯å¾‘ / å°ˆæ¡ˆè³‡æ–™å¤¾åç¨±

        if not æº–å‚™å°ˆæ¡ˆç¨‹å¼ç¢¼(åŸºç¤è·¯å¾‘, å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚å™¨å¯¦ä¾‹): return

        os.chdir(å°ˆæ¡ˆè·¯å¾‘)
        å°å‡ºæˆåŠŸ(f"å·¥ä½œç›®éŒ„å·²åˆ‡æ›è‡³: {os.getcwd()}")

        if not æº–å‚™ä¾è³´ç’°å¢ƒ(å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚å™¨å¯¦ä¾‹): return

        å•Ÿå‹•çš„ç¨‹åº = å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼(å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚å™¨å¯¦ä¾‹)
        if not å•Ÿå‹•çš„ç¨‹åº:
            print(f"\n{è‰²å½©.å¤±æ•—}âŒ æœªèƒ½å•Ÿå‹•ä»»ä½•æ‡‰ç”¨ç¨‹å¼ï¼Œå•Ÿå‹•ä¸­æ­¢ã€‚{è‰²å½©.çµæŸ}")
            return

        # æ¢å¾© stdout ä»¥é¡¯ç¤ºæœ€çµ‚å ±å‘Š
        sys.stdout = èˆŠçš„_stdout
        ç¸½çµå ±å‘Š, æ•ˆèƒ½å ±å‘Š = æœ€çµ‚ç¸½çµèˆ‡ç¶²å€æƒæ(å•Ÿå‹•çš„ç¨‹åº, è¨ˆæ™‚å™¨å¯¦ä¾‹)

        # å°‡æ•ç²çš„æ—¥èªŒå¯«å›ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥çœ‹åˆ°éç¨‹
        å®Œæ•´æ—¥èªŒ = æ—¥èªŒä¸²æµ.getvalue()
        print(å®Œæ•´æ—¥èªŒ)

        # è™•ç†æ—¥èªŒæ­¸æª”
        if æ—¥èªŒæ­¸æª”è³‡æ–™å¤¾:
            æ­¸æª”è·¯å¾‘ = åŸºç¤è·¯å¾‘ / æ—¥èªŒæ­¸æª”è³‡æ–™å¤¾
            æ­¸æª”è·¯å¾‘.mkdir(exist_ok=True)
            æ™‚é–“æˆ³ = datetime.now(datetime.strptime(æ™‚å€, '%Z').tzinfo if sys.platform != 'win32' else None).strftime("%Y-%m-%d_%H-%M-%S")
            æª”å = æ­¸æª”è·¯å¾‘ / f"ä½œæˆ°æ—¥èªŒ_{æ™‚é–“æˆ³}.md"

            # æ¸…ç† ANSI é¡è‰²ä»£ç¢¼
            ansi_escape = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')
            ä¹¾æ·¨æ—¥èªŒ = ansi_escape.sub('', å®Œæ•´æ—¥èªŒ)

            with æª”å.open("w", encoding="utf-8") as f:
                f.write(f"# é³³å‡°ä¹‹å¿ƒä½œæˆ°æ—¥èªŒ - {æ™‚é–“æˆ³}\n\n")
                f.write("## ä¸€ã€ç³»çµ±è¨­å®šæ‘˜è¦\n\n")
                f.write(f"- **å€‰åº«ç¶²å€**: {ç¨‹å¼ç¢¼å€‰åº«ç¶²å€}\n")
                f.write(f"- **ä½¿ç”¨ç‰ˆæœ¬**: {è¦ä½¿ç”¨çš„ç‰ˆæœ¬åˆ†æ”¯æˆ–æ¨™ç±¤}\n")
                f.write(f"- **å®‰è£æ¨¡å¼**: {å®‰è£æ¨¡å¼}\n\n")
                f.write(f"## äºŒã€æ•ˆèƒ½èˆ‡ç¸½çµ\n\n")
                f.write(ç¸½çµå ±å‘Š.replace("### ", "#### ") + "\n")
                f.write(æ•ˆèƒ½å ±å‘Š + "\n")
                f.write("## ä¸‰ã€è©³ç´°åŸ·è¡Œæ—¥èªŒ\n\n")
                f.write("```log\n")
                f.write(ä¹¾æ·¨æ—¥èªŒ)
                f.write("\n```\n")
            print_success(f"æœ¬æ¬¡ä½œæˆ°æ—¥èªŒå·²æ­¸æª”è‡³: {æª”å}")

        # ä¿æŒè…³æœ¬é‹è¡Œ
        while True: time.sleep(3600)

    except KeyboardInterrupt:
        sys.stdout = èˆŠçš„_stdout
        å°å‡ºè­¦å‘Š("\næ”¶åˆ°æ‰‹å‹•ä¸­æ–·ä¿¡è™Ÿï¼Œæ­£åœ¨é—œé–‰æ‰€æœ‰æœå‹™...")
        # æ­¤è™•ç„¡æ³•ç²å– `å•Ÿå‹•çš„ç¨‹åº` è®Šæ•¸ï¼Œæ•…æç¤ºä½¿ç”¨è€…æ‰‹å‹•è™•ç†
        print("è«‹æ³¨æ„ï¼šèƒŒæ™¯æœå‹™å¯èƒ½ä»åœ¨é‹è¡Œã€‚è«‹é€é Colab çš„ã€ŒåŸ·è¡Œéšæ®µã€->ã€Œä¸­æ–·åŸ·è¡Œã€ä¾†ç¢ºä¿å®Œå…¨åœæ­¢ã€‚")
    finally:
        sys.stdout = èˆŠçš„_stdout


if __name__ == "__main__":
    main()
