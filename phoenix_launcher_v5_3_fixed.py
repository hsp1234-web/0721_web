# -*- coding: utf-8 -*-
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                                 â•‘
# â•‘   ğŸš€ é³³å‡°ä¹‹å¿ƒ Colab æ•´åˆå•Ÿå‹•å™¨ v5.3 (è·¯å¾‘ä¿®æ­£ & æœ€çµ‚æ¸¬è©¦ç‰ˆ)                   â•‘
# â•‘                                                                                 â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘                                                                                 â•‘
# â•‘   v5.3 æ›´æ–° (Jules æœ€çµ‚ä¿®æ­£):                                                   â•‘
# â•‘       - **è·¯å¾‘å‹•æ…‹åŒ–**: ä¸å†ç¡¬æ€§ä¾è³´ `/content`ï¼Œè…³æœ¬æœƒè‡ªå‹•æª¢æ¸¬ä¸¦ä½¿ç”¨å­˜åœ¨      â•‘
# â•‘         çš„è·¯å¾‘ï¼Œä½¿å…¶åœ¨é Colab ç’°å¢ƒä¸­ä¹Ÿèƒ½é †åˆ©åŸ·è¡Œæ¨¡æ“¬æ¸¬è©¦ã€‚                     â•‘
# â•‘       - **ä¿®æ­£ TypeError**: ä¿®æ­£äº† `åŸ·è¡ŒæŒ‡ä»¤` å‡½æ•¸çš„å‘¼å«ã€‚                      â•‘
# â•‘       - **ä¾è³´è‡ªè¶³**: è‡ªå‹•å®‰è£è…³æœ¬è‡ªèº«é‹è¡Œçš„ `IPython` å’Œ `httpx`ã€‚             â•‘
# â•‘                                                                                 â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ====================================================================================
# Part 1: åƒæ•¸è¨­å®šå€ (è«‹åœ¨æ­¤è™•å®Œæˆæ‰€æœ‰è¨­å®š)
# ====================================================================================
#@title ğŸ’ é³³å‡°ä¹‹å¿ƒæŒ‡æ®ä¸­å¿ƒ (v5.3 æœ€çµ‚ä¿®æ­£ç‰ˆ) { vertical-output: true, display-mode: "form" }

#@markdown ---
#@markdown ### **ä¸€ã€åŸå§‹ç¢¼è¨­å®š**
#@markdown > **è¨­å®š Git å€‰åº«ä½å€ã€è¦ä½¿ç”¨çš„ç‰ˆæœ¬ (åˆ†æ”¯æˆ–æ¨™ç±¤)ï¼Œä»¥åŠå°ˆæ¡ˆåœ¨ Colab ä¸­çš„è³‡æ–™å¤¾åç¨±ã€‚**
#@markdown ---
ç¨‹å¼ç¢¼å€‰åº«ç¶²å€ = "https://github.com/hsp1234-web/0721_web" #@param {type:"string"}
è¦ä½¿ç”¨çš„ç‰ˆæœ¬åˆ†æ”¯æˆ–æ¨™ç±¤ = "3.1.0" #@param {type:"string"}
å°ˆæ¡ˆè³‡æ–™å¤¾åç¨± = "WEB" #@param {type:"string"}
#@markdown **å¼·åˆ¶åˆ·æ–°å¾Œç«¯ç¨‹å¼ç¢¼**
#@markdown >å‹¾é¸æ­¤é …æœƒåœ¨æœ¬æ©Ÿåˆªé™¤èˆŠçš„å°ˆæ¡ˆè³‡æ–™å¤¾ï¼Œä¸¦å¾ Git é‡æ–°ä¸‹è¼‰ã€‚
æ˜¯å¦å¼·åˆ¶åˆ·æ–°ç¨‹å¼ç¢¼ = True #@param {type:"boolean"}

#@markdown ---
#@markdown ### **äºŒã€å®‰è£èˆ‡å•Ÿå‹•è¨­å®š**
#@markdown > **é¸æ“‡å®‰è£æ¨¡å¼ã€è¨­å®šåŸ è™Ÿï¼Œä¸¦æ±ºå®šæ˜¯å¦åŸ·è¡Œå•Ÿå‹•å¾Œæ¸¬è©¦ã€‚**
#@markdown ---
å®‰è£æ¨¡å¼ = "æ¨¡æ“¬å®‰è£ (åƒ…æ ¸å¿ƒä¾è³´)" #@param ["å®Œæ•´å®‰è£ (åŒ…å«å¤§å‹ä¾è³´)", "æ¨¡æ“¬å®‰è£ (åƒ…æ ¸å¿ƒä¾è³´)"]
é‡åŒ–åˆ†ææœå‹™åŸ è™Ÿ = 8001 #@param {type:"integer"}
èªéŸ³è½‰å¯«æœå‹™åŸ è™Ÿ = 8002 #@param {type:"integer"}
#@markdown **åŸ·è¡Œå•Ÿå‹•å¾Œæ¨¡æ“¬æ¸¬è©¦ (Smoke Test)**
#@markdown >æœå‹™å•Ÿå‹•å¾Œï¼Œæœƒè‡ªå‹•é€éå…¬é–‹ç¶²å€æ¸¬è©¦ API é€£ç·šï¼Œç¢ºä¿æœå‹™å¯å¾å…¬ç¶²è¨ªå•ã€‚
æ˜¯å¦åŸ·è¡Œå•Ÿå‹•å¾Œæ¸¬è©¦ = True #@param {type:"boolean"}

#@markdown ---
#@markdown ### **ä¸‰ã€æ—¥èªŒèˆ‡æ™‚å€è¨­å®š**
#@markdown > **è¨­å®šæ—¥èªŒæ­¸æª”è³‡æ–™å¤¾åç¨±å’Œç³»çµ±æ™‚å€ã€‚**
#@markdown ---
æ—¥èªŒæ­¸æª”è³‡æ–™å¤¾ = "ä½œæˆ°æ—¥èªŒ" #@param {type:"string"}
æ™‚å€ = "Asia/Taipei" #@param {type:"string"}

# ====================================================================================
# Part 2: æ ¸å¿ƒå•Ÿå‹•é‚è¼¯ (é€šå¸¸ç„¡éœ€ä¿®æ”¹)
# ====================================================================================
import os
import sys
import subprocess
import shlex
import shutil
from pathlib import Path
import time
import re
from datetime import datetime
import asyncio

# --- å…¨åŸŸè¨­å®šèˆ‡è¼”åŠ©é¡åˆ¥ ---
class è‰²å½©:
    æ¨™é¡Œ = '\033[95m'; æˆåŠŸ = '\033[92m'; è­¦å‘Š = '\033[93m'; å¤±æ•— = '\033[91m'
    çµæŸ = '\033[0m'; ç²—é«” = '\033[1m'

class è¨ˆæ™‚å™¨:
    def __init__(self): self.ç´€éŒ„ = [("å•Ÿå‹•", time.time())]
    def æ¨™è¨˜(self, åç¨±): self.ç´€éŒ„.append((åç¨±, time.time()))
    def ç”¢ç”Ÿå ±å‘Š(self):
        å ±å‘Š = "### â±ï¸ æ•ˆèƒ½åˆ†ææ‘˜è¦\n\n| éšæ®µ | è€—æ™‚ (ç§’) |\n| :--- | :--- |\n"
        for i in range(1, len(self.ç´€éŒ„)):
            å ±å‘Š += f"| {self.ç´€éŒ„[i-1][0]} | {self.ç´€éŒ„[i][1] - self.ç´€éŒ„[i-1][1]:.2f} |\n"
        å ±å‘Š += f"| **ç¸½è¨ˆ** | **{self.ç´€éŒ„[-1][1] - self.ç´€éŒ„[0][1]:.2f}** |\n"
        return å ±å‘Š

# --- è¼”åŠ©å‡½æ•¸ ---
def å°å‡ºæ¨™é¡Œ(è¨Šæ¯): print(f"\n{è‰²å½©.æ¨™é¡Œ}{è‰²å½©.ç²—é«”}ğŸš€ {è¨Šæ¯} ğŸš€{è‰²å½©.çµæŸ}")
def å°å‡ºæˆåŠŸ(è¨Šæ¯): print(f"{è‰²å½©.æˆåŠŸ}âœ… {è¨Šæ¯}{è‰²å½©.çµæŸ}")
def å°å‡ºè­¦å‘Š(è¨Šæ¯): print(f"{è‰²å½©.è­¦å‘Š}âš ï¸ {è¨Šæ¯}{è‰²å½©.çµæŸ}")
def å°å‡ºè³‡è¨Š(è¨Šæ¯): print(f"â„¹ï¸ {è¨Šæ¯}")

def åŸ·è¡ŒæŒ‡ä»¤(æŒ‡ä»¤, å·¥ä½œç›®éŒ„):
    å·¥ä½œç›®éŒ„.mkdir(exist_ok=True, parents=True) # ç¢ºä¿å·¥ä½œç›®éŒ„å­˜åœ¨
    å°å‡ºè³‡è¨Š(f"åœ¨ '{å·¥ä½œç›®éŒ„}' ä¸­åŸ·è¡Œ: {è‰²å½©.ç²—é«”}{æŒ‡ä»¤}{è‰²å½©.çµæŸ}")
    ç¨‹åº = subprocess.Popen(
        shlex.split(æŒ‡ä»¤), stdout=subprocess.PIPE, stderr=subprocess.STDOUT,
        cwd=å·¥ä½œç›®éŒ„, text=True, encoding='utf-8', errors='replace'
    )
    æ—¥èªŒè¼¸å‡º = [f"--- {æŒ‡ä»¤} ---"]; print(f"   --- {æŒ‡ä»¤} ---")
    while True:
        è¼¸å‡º = ç¨‹åº.stdout.readline()
        if è¼¸å‡º == '' and ç¨‹åº.poll() is not None: break
        if è¼¸å‡º:
            ä¹¾æ·¨è¼¸å‡º = è¼¸å‡º.strip()
            print(f"   {ä¹¾æ·¨è¼¸å‡º}"); æ—¥èªŒè¼¸å‡º.append(ä¹¾æ·¨è¼¸å‡º)
    return ç¨‹åº.wait(), æ—¥èªŒè¼¸å‡º

# --- ä¸»è¦åŠŸèƒ½å‡½æ•¸ ---
def æº–å‚™åŸ·è¡Œç’°å¢ƒ(åŸºç¤è·¯å¾‘, è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 1/6: æº–å‚™è…³æœ¬åŸ·è¡Œç’°å¢ƒ")
    # å¢åŠ  nest_asyncio ä»¥è§£æ±º Colab ä¸­çš„ asyncio.run() å•é¡Œ
    è¿”å›ç¢¼, _ = åŸ·è¡ŒæŒ‡ä»¤(f"{sys.executable} -m pip install -q IPython httpx nest_asyncio", åŸºç¤è·¯å¾‘)
    if è¿”å›ç¢¼ != 0:
        å°å‡ºå¤±æ•—("å®‰è£æ ¸å¿ƒè…³æœ¬ä¾è³´ (IPython, httpx, nest_asyncio) å¤±æ•—ï¼")
        return False
    å°å‡ºæˆåŠŸ("æ ¸å¿ƒè…³æœ¬ä¾è³´å·²æº–å‚™å°±ç·’ã€‚")
    è¨ˆæ™‚.æ¨™è¨˜("æº–å‚™å°ˆæ¡ˆç¨‹å¼ç¢¼")
    return True

def æº–å‚™å°ˆæ¡ˆç¨‹å¼ç¢¼(åŸºç¤è·¯å¾‘, å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 2/6: æº–å‚™å°ˆæ¡ˆç¨‹å¼ç¢¼")
    if æ˜¯å¦å¼·åˆ¶åˆ·æ–°ç¨‹å¼ç¢¼ and å°ˆæ¡ˆè·¯å¾‘.exists():
        shutil.rmtree(å°ˆæ¡ˆè·¯å¾‘); å°å‡ºæˆåŠŸ("èˆŠè³‡æ–™å¤¾å·²ç§»é™¤ã€‚")
    if not å°ˆæ¡ˆè·¯å¾‘.exists():
        æŒ‡ä»¤ = f"git clone -q --branch {è¦ä½¿ç”¨çš„ç‰ˆæœ¬åˆ†æ”¯æˆ–æ¨™ç±¤} --depth 1 {ç¨‹å¼ç¢¼å€‰åº«ç¶²å€} {å°ˆæ¡ˆè·¯å¾‘.name}"
        è¿”å›ç¢¼, _ = åŸ·è¡ŒæŒ‡ä»¤(æŒ‡ä»¤, åŸºç¤è·¯å¾‘)
        if è¿”å›ç¢¼ != 0: return False
        å°å‡ºæˆåŠŸ("ç¨‹å¼ç¢¼æˆåŠŸä¸‹è¼‰ï¼")
    è¨ˆæ™‚.æ¨™è¨˜("æº–å‚™ä¾è³´ç’°å¢ƒ")
    return True

def æº–å‚™ä¾è³´ç’°å¢ƒ(å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 3/6: æº–å‚™ä¾è³´ç’°å¢ƒ (æ··åˆå¼)")
    æ‡‰ç”¨ç¨‹å¼ç›®éŒ„ = å°ˆæ¡ˆè·¯å¾‘ / "apps"; è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„ = Path(f"/dev/shm/{å°ˆæ¡ˆè³‡æ–™å¤¾åç¨±}_venvs") if sys.platform == "linux" else å°ˆæ¡ˆè·¯å¾‘ / ".venvs"
    å¤§å‹ä¾è³´æ ¹ç›®éŒ„ = å°ˆæ¡ˆè·¯å¾‘ / ".large_packages"; æ˜¯å¦å®‰è£å¤§å‹ä¾è³´ = "å®Œæ•´å®‰è£" in å®‰è£æ¨¡å¼
    try: subprocess.check_output(["uv", "--version"], stderr=subprocess.STDOUT)
    except:
        è¿”å›ç¢¼, _ = åŸ·è¡ŒæŒ‡ä»¤(f"{sys.executable} -m pip install -q uv", å°ˆæ¡ˆè·¯å¾‘)
        if è¿”å›ç¢¼ != 0: return False
    if è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„.exists(): shutil.rmtree(è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„)
    if å¤§å‹ä¾è³´æ ¹ç›®éŒ„.exists(): shutil.rmtree(å¤§å‹ä¾è³´æ ¹ç›®éŒ„)
    è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„.mkdir(parents=True, exist_ok=True)
    if æ˜¯å¦å®‰è£å¤§å‹ä¾è³´: å¤§å‹ä¾è³´æ ¹ç›®éŒ„.mkdir(parents=True, exist_ok=True)
    for æ‡‰ç”¨è·¯å¾‘ in (d for d in æ‡‰ç”¨ç¨‹å¼ç›®éŒ„.iterdir() if d.is_dir()):
        æ‡‰ç”¨åç¨± = æ‡‰ç”¨è·¯å¾‘.name; è™›æ“¬ç’°å¢ƒè·¯å¾‘ = è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„ / æ‡‰ç”¨åç¨±
        PythonåŸ·è¡Œæª” = è™›æ“¬ç’°å¢ƒè·¯å¾‘ / 'bin/python'
        if åŸ·è¡ŒæŒ‡ä»¤(f"uv venv '{è™›æ“¬ç’°å¢ƒè·¯å¾‘}' --seed", å°ˆæ¡ˆè·¯å¾‘)[0] != 0: return False
        if (p := æ‡‰ç”¨è·¯å¾‘ / "requirements.txt").exists() and åŸ·è¡ŒæŒ‡ä»¤(f"uv pip install --python '{PythonåŸ·è¡Œæª”}' -r '{p}'", å°ˆæ¡ˆè·¯å¾‘)[0] != 0: return False
        if æ˜¯å¦å®‰è£å¤§å‹ä¾è³´ and (p := æ‡‰ç”¨è·¯å¾‘ / "requirements.large.txt").exists():
            ç›®æ¨™ç›®éŒ„ = å¤§å‹ä¾è³´æ ¹ç›®éŒ„ / æ‡‰ç”¨åç¨±; ç›®æ¨™ç›®éŒ„.mkdir(exist_ok=True)
            if åŸ·è¡ŒæŒ‡ä»¤(f"uv pip install --target '{ç›®æ¨™ç›®éŒ„}' -r '{p}'", å°ˆæ¡ˆè·¯å¾‘)[0] != 0: return False
    è¨ˆæ™‚.æ¨™è¨˜("å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼")
    return True

def å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼(å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 4/6: å•Ÿå‹•æ‰€æœ‰æ‡‰ç”¨ç¨‹å¼")
    æ‡‰ç”¨ç¨‹å¼ç›®éŒ„ = å°ˆæ¡ˆè·¯å¾‘ / "apps"; è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„ = Path(f"/dev/shm/{å°ˆæ¡ˆè³‡æ–™å¤¾åç¨±}_venvs") if sys.platform == "linux" else å°ˆæ¡ˆè·¯å¾‘ / ".venvs"
    å¤§å‹ä¾è³´æ ¹ç›®éŒ„ = å°ˆæ¡ˆè·¯å¾‘ / ".large_packages"; æ˜¯å¦å®‰è£å¤§å‹ä¾è³´ = "å®Œæ•´å®‰è£" in å®‰è£æ¨¡å¼
    æ‡‰ç”¨åŸ è™Ÿ = {"quant": é‡åŒ–åˆ†ææœå‹™åŸ è™Ÿ, "transcriber": èªéŸ³è½‰å¯«æœå‹™åŸ è™Ÿ}; å•Ÿå‹•çš„ç¨‹åº = []
    for æ‡‰ç”¨è·¯å¾‘ in (d for d in æ‡‰ç”¨ç¨‹å¼ç›®éŒ„.iterdir() if d.is_dir()):
        æ‡‰ç”¨åç¨± = æ‡‰ç”¨è·¯å¾‘.name.replace('_test', ''); åŸ è™Ÿ = æ‡‰ç”¨åŸ è™Ÿ.get(æ‡‰ç”¨åç¨±) # ç§»é™¤ _test ä»¥åŒ¹é…
        if not åŸ è™Ÿ: continue
        è™›æ“¬ç’°å¢ƒè·¯å¾‘ = è™›æ“¬ç’°å¢ƒæ ¹ç›®éŒ„ / æ‡‰ç”¨è·¯å¾‘.name; PythonåŸ·è¡Œæª” = è™›æ“¬ç’°å¢ƒè·¯å¾‘ / 'bin/python'
        ç’°å¢ƒè®Šæ•¸ = os.environ.copy(); Pythonè·¯å¾‘åˆ—è¡¨ = [str(å°ˆæ¡ˆè·¯å¾‘)]
        if æ˜¯å¦å®‰è£å¤§å‹ä¾è³´ and (p := å¤§å‹ä¾è³´æ ¹ç›®éŒ„ / æ‡‰ç”¨è·¯å¾‘.name).exists(): Pythonè·¯å¾‘åˆ—è¡¨.append(str(p))
        if (p_dir := next((è™›æ“¬ç’°å¢ƒè·¯å¾‘ / "lib").glob("python*"), None)) and (p_site := p_dir / "site-packages").exists(): Pythonè·¯å¾‘åˆ—è¡¨.append(str(p_site))
        ç’°å¢ƒè®Šæ•¸.update({"PYTHONPATH": os.pathsep.join(Pythonè·¯å¾‘åˆ—è¡¨), "PORT": str(åŸ è™Ÿ), "TIMEZONE": æ™‚å€})
        æ—¥èªŒæª”æ¡ˆ = Path(f"./{æ‡‰ç”¨è·¯å¾‘.name}.log")
        ç¨‹åº = subprocess.Popen([str(PythonåŸ·è¡Œæª”), str(æ‡‰ç”¨è·¯å¾‘ / "main.py")], env=ç’°å¢ƒè®Šæ•¸, stdout=æ—¥èªŒæª”æ¡ˆ.open('w'), stderr=subprocess.STDOUT)
        å•Ÿå‹•çš„ç¨‹åº.append(ç¨‹åº); å°å‡ºæˆåŠŸ(f"App '{æ‡‰ç”¨è·¯å¾‘.name}' (PID: {ç¨‹åº.pid}) å·²åœ¨èƒŒæ™¯å•Ÿå‹•ï¼Œæ—¥èªŒä½æ–¼ {æ—¥èªŒæª”æ¡ˆ}")
    è¨ˆæ™‚.æ¨™è¨˜("ç”Ÿæˆå…¬é–‹ç¶²å€")
    return å•Ÿå‹•çš„ç¨‹åº

def ç”Ÿæˆä¸¦é¡¯ç¤ºç¶²å€(è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 5/6: ç”Ÿæˆ Colab åŸç”Ÿå…¬é–‹ç¶²å€")
    try:
        from google.colab.output import eval_js
        is_colab = True
    except ImportError:
        is_colab = False

    å…¬é–‹ç¶²å€ = {}
    for åç¨±, åŸ è™Ÿ in [("é‡åŒ–åˆ†ææœå‹™", é‡åŒ–åˆ†ææœå‹™åŸ è™Ÿ), ("èªéŸ³è½‰å¯«æœå‹™", èªéŸ³è½‰å¯«æœå‹™åŸ è™Ÿ)]:
        if is_colab:
            url = eval_js(f"google.colab.kernel.proxyPort({åŸ è™Ÿ})")
        else:
            url = f"http://localhost:{åŸ è™Ÿ}"
        å…¬é–‹ç¶²å€[åç¨±] = url
        å°å‡ºæˆåŠŸ(f"ğŸŒ {åç¨±} ç¶²å€: {url}")

    è¨ˆæ™‚.æ¨™è¨˜("åŸ·è¡Œå•Ÿå‹•å¾Œæ¨¡æ“¬æ¸¬è©¦")
    return å…¬é–‹ç¶²å€

async def åŸ·è¡Œæ¨¡æ“¬æ¸¬è©¦(å…¬é–‹ç¶²å€, è¨ˆæ™‚):
    å°å‡ºæ¨™é¡Œ("æ­¥é©Ÿ 6/6: åŸ·è¡Œå•Ÿå‹•å¾Œæ¨¡æ“¬æ¸¬è©¦ (Smoke Test)")
    if not æ˜¯å¦åŸ·è¡Œå•Ÿå‹•å¾Œæ¸¬è©¦:
        å°å‡ºè­¦å‘Š("å·²è·³éå•Ÿå‹•å¾Œæ¨¡æ“¬æ¸¬è©¦ã€‚"); è¨ˆæ™‚.æ¨™è¨˜("å®Œæˆ")
        return True, "å·²è·³é"

    import httpx
    çµæœ = []; å°å‡ºè³‡è¨Š("ç­‰å¾… 10 ç§’è®“ä¼ºæœå™¨å®Œå…¨å•Ÿå‹•..."); await asyncio.sleep(10)
    async with httpx.AsyncClient(timeout=30.0, verify=False) as client:
        for åç¨±, url in å…¬é–‹ç¶²å€.items():
            æ¸¬è©¦è·¯å¾‘ = url.rstrip('/') + "/docs"
            try:
                å°å‡ºè³‡è¨Š(f"æ­£åœ¨å‘ '{åç¨±}' ç™¼é€è«‹æ±‚: GET {æ¸¬è©¦è·¯å¾‘}")
                å›æ‡‰ = await client.get(æ¸¬è©¦è·¯å¾‘)
                if 200 <= å›æ‡‰.status_code < 500:
                    å°å‡ºæˆåŠŸ(f"'{åç¨±}' æ¸¬è©¦æˆåŠŸï¼æœå‹™å¯é”ï¼Œç‹€æ…‹ç¢¼: {å›æ‡‰.status_code}"); çµæœ.append(True)
                else:
                    å°å‡ºå¤±æ•—(f"'{åç¨±}' æ¸¬è©¦å¤±æ•—ï¼ä¼ºæœå™¨éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼: {å›æ‡‰.status_code}"); çµæœ.append(False)
            except httpx.RequestError as e:
                å°å‡ºå¤±æ•—(f"'{åç¨±}' æ¸¬è©¦æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤: {e}"); çµæœ.append(False)

    è¨ˆæ™‚.æ¨™è¨˜("å®Œæˆ"); å…¨éƒ¨æˆåŠŸ = all(çµæœ)
    return å…¨éƒ¨æˆåŠŸ, f"{'âœ… å…¨æ•¸é€šé' if å…¨éƒ¨æˆåŠŸ else 'âŒ éƒ¨åˆ†å¤±æ•—'} ({sum(çµæœ)}/{len(çµæœ)})"

# --- ä¸»åŸ·è¡Œæµç¨‹ ---
async def run_async_tasks(å…¬é–‹ç¶²å€, è¨ˆæ™‚å™¨å¯¦ä¾‹, å®Œæ•´æ—¥èªŒ_éç¨‹):
    """åŸ·è¡Œæ‰€æœ‰éœ€è¦éåŒæ­¥æ“ä½œçš„ä»»å‹™ï¼Œä¾‹å¦‚ API æ¸¬è©¦ã€‚"""
    from io import StringIO
    from IPython.display import display, Markdown

    èˆŠçš„_stdout = sys.stdout
    æ—¥èªŒä¸²æµ = StringIO()
    sys.stdout = æ—¥èªŒä¸²æµ

    æ¸¬è©¦çµæœ, æ¸¬è©¦æ‘˜è¦ = await åŸ·è¡Œæ¨¡æ“¬æ¸¬è©¦(å…¬é–‹ç¶²å€, è¨ˆæ™‚å™¨å¯¦ä¾‹)

    sys.stdout = èˆŠçš„_stdout
    å®Œæ•´æ—¥èªŒ_æ¸¬è©¦ = æ—¥èªŒä¸²æµ.getvalue()
    print(å®Œæ•´æ—¥èªŒ_æ¸¬è©¦)

    return æ¸¬è©¦çµæœ, æ¸¬è©¦æ‘˜è¦, å®Œæ•´æ—¥èªŒ_æ¸¬è©¦

def main_sync():
    """ç¨‹å¼ä¸»é€²å…¥é»ï¼Œå”èª¿åŒæ­¥èˆ‡éåŒæ­¥ä»»å‹™ã€‚"""
    è¨ˆæ™‚å™¨å¯¦ä¾‹ = è¨ˆæ™‚å™¨()
    åŸºç¤è·¯å¾‘ = Path("/content") if Path("/content").exists() else Path.cwd()

    # --- Part 1: åŒæ­¥åŸ·è¡Œæ‰€æœ‰æº–å‚™å·¥ä½œ ---
    if not æº–å‚™åŸ·è¡Œç’°å¢ƒ(åŸºç¤è·¯å¾‘, è¨ˆæ™‚å™¨å¯¦ä¾‹): return

    from io import StringIO
    from IPython.display import display, Markdown

    # æ¸…ç† Colab è¼¸å‡º
    try:
        from IPython.display import clear_output
        clear_output(wait=True)
    except ImportError:
        pass

    # ç‚ºäº†æ•æ‰éç¨‹æ—¥èªŒï¼Œæˆ‘å€‘æš«æ™‚é‡å®šå‘ stdout
    èˆŠçš„_stdout = sys.stdout
    æ—¥èªŒä¸²æµ = StringIO()
    sys.stdout = æ—¥èªŒä¸²æµ

    å°ˆæ¡ˆè·¯å¾‘ = åŸºç¤è·¯å¾‘ / å°ˆæ¡ˆè³‡æ–™å¤¾åç¨±
    if not æº–å‚™å°ˆæ¡ˆç¨‹å¼ç¢¼(åŸºç¤è·¯å¾‘, å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚å™¨å¯¦ä¾‹):
        sys.stdout = èˆŠçš„_stdout
        print(æ—¥èªŒä¸²æµ.getvalue())
        return

    os.chdir(å°ˆæ¡ˆè·¯å¾‘)
    å°å‡ºæˆåŠŸ(f"å·¥ä½œç›®éŒ„å·²åˆ‡æ›è‡³: {os.getcwd()}")

    if not æº–å‚™ä¾è³´ç’°å¢ƒ(å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚å™¨å¯¦ä¾‹):
        sys.stdout = èˆŠçš„_stdout
        print(æ—¥èªŒä¸²æµ.getvalue())
        return

    å•Ÿå‹•çš„ç¨‹åº = å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼(å°ˆæ¡ˆè·¯å¾‘, è¨ˆæ™‚å™¨å¯¦ä¾‹)
    if not å•Ÿå‹•çš„ç¨‹åº:
        sys.stdout = èˆŠçš„_stdout
        print(æ—¥èªŒä¸²æµ.getvalue())
        return

    # æ¢å¾© stdoutï¼Œä¸¦å°å‡ºè‡³ä»Šç‚ºæ­¢çš„æ—¥èªŒ
    sys.stdout = èˆŠçš„_stdout
    å®Œæ•´æ—¥èªŒ_éç¨‹ = æ—¥èªŒä¸²æµ.getvalue()
    print(å®Œæ•´æ—¥èªŒ_éç¨‹)

    # --- Part 2: åŸ·è¡Œç¶²å€ç”Ÿæˆèˆ‡éåŒæ­¥æ¸¬è©¦ ---
    å…¬é–‹ç¶²å€ = ç”Ÿæˆä¸¦é¡¯ç¤ºç¶²å€(è¨ˆæ™‚å™¨å¯¦ä¾‹)

    # å®‰å…¨åœ°åŸ·è¡ŒéåŒæ­¥ä»»å‹™
    import nest_asyncio
    nest_asyncio.apply()
    æ¸¬è©¦çµæœ, æ¸¬è©¦æ‘˜è¦, å®Œæ•´æ—¥èªŒ_æ¸¬è©¦ = asyncio.run(run_async_tasks(å…¬é–‹ç¶²å€, è¨ˆæ™‚å™¨å¯¦ä¾‹, å®Œæ•´æ—¥èªŒ_éç¨‹))

    # --- Part 3: ç”¢ç”Ÿæœ€çµ‚å ±å‘Šä¸¦æ­¸æª” ---
    ç¸½çµå ±å‘Š = f"### âœ… é³³å‡°ä¹‹å¿ƒç³»çµ±å·²æˆåŠŸå•Ÿå‹•ï¼\n\n**æ¨¡æ“¬æ¸¬è©¦çµæœ**: **{æ¸¬è©¦æ‘˜è¦}**\n\n**å„æœå‹™æ­£åœ¨èƒŒæ™¯é‹è¡Œä¸­ (PIDs: {', '.join(str(p.pid) for p in å•Ÿå‹•çš„ç¨‹åº)})**\n"
    for åç¨±, url in å…¬é–‹ç¶²å€.items():
        ç¸½çµå ±å‘Š += f"- **{åç¨±}**: [{url}]({url})\n"
    display(Markdown("---"), Markdown(ç¸½çµå ±å‘Š))

    if æ—¥èªŒæ­¸æª”è³‡æ–™å¤¾:
        æ­¸æª”è·¯å¾‘ = åŸºç¤è·¯å¾‘ / æ—¥èªŒæ­¸æª”è³‡æ–™å¤¾
        æ­¸æª”è·¯å¾‘.mkdir(exist_ok=True)
        æ™‚é–“æˆ³ = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
        æª”å = æ­¸æª”è·¯å¾‘ / f"ä½œæˆ°æ—¥èªŒ_{æ™‚é–“æˆ³}.md"
        ansi_escape = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')
        with æª”å.open("w", encoding="utf-8") as f:
            f.write(f"# ä½œæˆ°æ—¥èªŒ {æ™‚é–“æˆ³}\n\n## ä¸€ã€è¨­å®šæ‘˜è¦\n- **å€‰åº«**: {ç¨‹å¼ç¢¼å€‰åº«ç¶²å€} (ç‰ˆæœ¬: {è¦ä½¿ç”¨çš„ç‰ˆæœ¬åˆ†æ”¯æˆ–æ¨™ç±¤})\n- **å®‰è£æ¨¡å¼**: {å®‰è£æ¨¡å¼}\n\n")
            f.write(f"## äºŒã€å•Ÿå‹•ç¸½çµ\n{ç¸½çµå ±å‘Š}\n\n{è¨ˆæ™‚å™¨å¯¦ä¾‹.ç”¢ç”Ÿå ±å‘Š()}\n\n")
            f.write(f"## ä¸‰ã€è©³ç´°åŸ·è¡Œæ—¥èªŒ\n```log\n{ansi_escape.sub('', å®Œæ•´æ—¥èªŒ_éç¨‹ + å®Œæ•´æ—¥èªŒ_æ¸¬è©¦)}\n```")
        å°å‡ºæˆåŠŸ(f"æœ¬æ¬¡ä½œæˆ°æ—¥èªŒå·²æ­¸æª”è‡³: {æª”å}")

    # --- Part 4: ä¿æŒ Colab å„²å­˜æ ¼æ´»èº ---
    å°å‡ºè³‡è¨Š("ç³»çµ±å·²å•Ÿå‹•ï¼Œé€²å…¥ç›£æ§æ¨¡å¼ã€‚ä¸­æ–·åŸ·è¡Œ (Ctrl+C) ä»¥é—œé–‰æ‰€æœ‰æœå‹™ã€‚")
    try:
        while True:
            for p in å•Ÿå‹•çš„ç¨‹åº:
                if p.poll() is not None:
                    å°å‡ºè­¦å‘Š(f"è­¦å‘Šï¼šåµæ¸¬åˆ°é€²ç¨‹ PID {p.pid} å·²çµ‚æ­¢ã€‚è«‹æª¢æŸ¥æ—¥èªŒæª”æ¡ˆã€‚")
            time.sleep(60)
    except KeyboardInterrupt:
        å°å‡ºè­¦å‘Š("\næ”¶åˆ°æ‰‹å‹•ä¸­æ–·ä¿¡è™Ÿï¼Œæ­£åœ¨å˜—è©¦é—œé–‰æ‰€æœ‰èƒŒæ™¯æœå‹™...")
        for p in å•Ÿå‹•çš„ç¨‹åº:
            p.terminate()
        # ç­‰å¾…ä¸€å°æ®µæ™‚é–“è®“ç¨‹åºçµ‚æ­¢
        time.sleep(2)
        for p in å•Ÿå‹•çš„ç¨‹åº:
            if p.poll() is None: # å¦‚æœé‚„åœ¨é‹è¡Œ
                p.kill() # å¼·åˆ¶çµ‚æ­¢
        å°å‡ºæˆåŠŸ("æ‰€æœ‰èƒŒæ™¯æœå‹™å·²é—œé–‰ã€‚")
    except Exception as e:
        import traceback
        traceback.print_exc()
    finally:
        å°å‡ºæˆåŠŸ("é³³å‡°ä¹‹å¿ƒå•Ÿå‹•å™¨å·²çµæŸã€‚")

if __name__ == "__main__":
    main_sync()
