--- 正在啟動 Poetry 環境中的測試套件 ---
============================= test session starts ==============================
platform linux -- Python 3.12.11, pytest-8.4.1, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
plugins: anyio-4.9.0
collected 6 items

integrated_platform/tests/e2e/test_full_system_flow.py E                 [ 16%]
integrated_platform/tests/ignition_test.py F                             [ 33%]
integrated_platform/tests/test_final_deployment.py F                     [ 50%]
integrated_platform/tests/test_main.py ..F                               [100%]

==================================== ERRORS ====================================
________________ ERROR at setup of test_full_transcription_flow ________________

    @pytest.fixture(scope="module")
    def server_is_ready():
        """一個 fixture，用來檢查伺服器是否已準備好接收請求。"""
        start_time = time.time()
        while time.time() - start_time < 120:  # 120 秒超時
            try:
                response = requests.get(f"{BASE_URL}/api/apps")
                if response.status_code == 200:
                    return True
            except requests.ConnectionError:
                time.sleep(1)
>       pytest.fail("伺服器在 120 秒內未能啟動。")
E       Failed: 伺服器在 120 秒內未能啟動。

integrated_platform/tests/e2e/test_full_system_flow.py:22: Failed
=================================== FAILURES ===================================
___________________________ test_import_all_modules ____________________________

    def test_import_all_modules():
        """
        Imports all modules in the src directory to check for import errors.
        """
        try:
>           from src import archiver  # noqa: F401
            ^^^^^^^^^^^^^^^^^^^^^^^^
E           ModuleNotFoundError: No module named 'src'

integrated_platform/tests/ignition_test.py:8: ModuleNotFoundError

During handling of the above exception, another exception occurred:

    def test_import_all_modules():
        """
        Imports all modules in the src directory to check for import errors.
        """
        try:
            from src import archiver  # noqa: F401
            from src import commander_console  # noqa: F401
            from src import display_manager  # noqa: F401
            from src import generate_log_report  # noqa: F401
            from src import log_manager  # noqa: F401
        except ImportError as e:
>           pytest.fail(f"Failed to import modules: {e}")
E           Failed: Failed to import modules: No module named 'src'

integrated_platform/tests/ignition_test.py:14: Failed
___________________ test_final_run_sh_in_simulated_colab_env ___________________

final_colab_env = (PosixPath('/tmp/pytest-of-swebot/pytest-1/test_final_run_sh_in_simulated0/content'), PosixPath('/tmp/pytest-of-swebot/pytest-1/test_final_run_sh_in_simulated0/content/WEB'))

    def test_final_run_sh_in_simulated_colab_env(final_colab_env):
        """
        驗證：使用最終版的 run.sh，在一個模擬的 Colab 環境中執行，
        應該能成功完成所有階段，並且 poetry 不會建立 venv。
        """
        content_dir, project_dir = final_colab_env

        # 模擬 Colab 環境變數
        env = os.environ.copy()
        env["COLAB_GPU"] = "1"
        env["UVICORN_PORT"] = "8889" # 使用一個新的埠號

        # 執行部署腳本
        # 這次我們執行完整的 run.sh，因為我們也想驗證 FastAPI 能否啟動
        process = subprocess.Popen(
            ["bash", str(project_dir / "run.sh")],
            cwd=project_dir, # 這次我們直接從專案目錄執行，因為 run.sh 內部會 cd
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            text=True,
            encoding='utf-8',
            env=env
        )

        # 讀取並打印即時輸出，同時進行檢查
        output_lines = []
        venv_created = False
        ansi_escape = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')
        for line in iter(process.stdout.readline, ''):
            clean_line = ansi_escape.sub('', line).strip()
            print(clean_line)
            output_lines.append(clean_line)
            if "Creating virtualenv" in clean_line or "Using virtualenv" in clean_line:
                venv_created = True

        process.stdout.close()
        return_code = process.wait()

        full_output = "".join(output_lines)

        # 斷言
        assert venv_created is False, "Poetry 不應該在 Colab 模式下建立虛擬環境"
>       assert any("==> [Phase: Environment Sensing] 環境變數 POETRY_VIRTUALENVS_CREATE 已設定為 false。" in line for line in output_lines), "日誌中應包含設定環境變數的訊息"
E       AssertionError: 日誌中應包含設定環境變數的訊息
E       assert False
E        +  where False = any(<generator object test_final_run_sh_in_simulated_colab_env.<locals>.<genexpr> at 0x7f423932acf0>)

integrated_platform/tests/test_final_deployment.py:82: AssertionError
----------------------------- Captured stdout call -----------------------------
--- 正在安裝核心引導工具 ---
Requirement already satisfied: poetry in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (2.1.3)
Requirement already satisfied: psutil in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (7.0.0)
Requirement already satisfied: ipython in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (8.37.0)
Requirement already satisfied: toml in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (0.10.2)
Requirement already satisfied: build<2.0.0,>=1.2.1 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (1.2.2.post1)
Requirement already satisfied: cachecontrol<0.15.0,>=0.14.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from cachecontrol[filecache]<0.15.0,>=0.14.0->poetry) (0.14.3)
Requirement already satisfied: cleo<3.0.0,>=2.1.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (2.1.0)
Requirement already satisfied: dulwich<0.23.0,>=0.22.6 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (0.22.8)
Requirement already satisfied: fastjsonschema<3.0.0,>=2.18.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (2.21.1)
Requirement already satisfied: findpython<0.7.0,>=0.6.2 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (0.6.3)
Requirement already satisfied: installer<0.8.0,>=0.7.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (0.7.0)
Requirement already satisfied: keyring<26.0.0,>=25.1.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (25.6.0)
Requirement already satisfied: packaging>=24.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (25.0)
Requirement already satisfied: pbs-installer<2026.0.0,>=2025.1.6 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (2025.7.12)
Requirement already satisfied: pkginfo<2.0,>=1.12 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (1.12.1.2)
Requirement already satisfied: platformdirs<5,>=3.0.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (4.3.8)
Requirement already satisfied: poetry-core==2.1.3 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (2.1.3)
Requirement already satisfied: pyproject-hooks<2.0.0,>=1.0.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (1.2.0)
Requirement already satisfied: requests<3.0,>=2.26 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (2.32.4)
Requirement already satisfied: requests-toolbelt<2.0.0,>=1.0.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (1.0.0)
Requirement already satisfied: shellingham<2.0,>=1.5 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (1.5.4)
Requirement already satisfied: tomlkit<1.0.0,>=0.11.4 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (0.13.3)
Requirement already satisfied: trove-classifiers>=2022.5.19 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (2025.5.9.12)
Requirement already satisfied: virtualenv<21.0.0,>=20.26.6 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from poetry) (20.32.0)
Requirement already satisfied: msgpack<2.0.0,>=0.5.2 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from cachecontrol<0.15.0,>=0.14.0->cachecontrol[filecache]<0.15.0,>=0.14.0->poetry) (1.1.1)
Requirement already satisfied: filelock>=3.8.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from cachecontrol[filecache]<0.15.0,>=0.14.0->poetry) (3.18.0)
Requirement already satisfied: crashtest<0.5.0,>=0.4.1 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from cleo<3.0.0,>=2.1.0->poetry) (0.4.1)
Requirement already satisfied: rapidfuzz<4.0.0,>=3.0.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from cleo<3.0.0,>=2.1.0->poetry) (3.13.0)
Requirement already satisfied: urllib3>=1.25 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from dulwich<0.23.0,>=0.22.6->poetry) (2.5.0)
Requirement already satisfied: SecretStorage>=3.2 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from keyring<26.0.0,>=25.1.0->poetry) (3.3.3)
Requirement already satisfied: jeepney>=0.4.2 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from keyring<26.0.0,>=25.1.0->poetry) (0.9.0)
Requirement already satisfied: jaraco.classes in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from keyring<26.0.0,>=25.1.0->poetry) (3.4.0)
Requirement already satisfied: jaraco.functools in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from keyring<26.0.0,>=25.1.0->poetry) (4.2.1)
Requirement already satisfied: jaraco.context in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from keyring<26.0.0,>=25.1.0->poetry) (6.0.1)
Requirement already satisfied: httpx<1,>=0.27.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (0.28.1)
Requirement already satisfied: zstandard>=0.21.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (0.23.0)
Requirement already satisfied: anyio in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from httpx<1,>=0.27.0->pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (4.9.0)
Requirement already satisfied: certifi in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from httpx<1,>=0.27.0->pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (2025.7.14)
Requirement already satisfied: httpcore==1.* in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from httpx<1,>=0.27.0->pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (1.0.8)
Requirement already satisfied: idna in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from httpx<1,>=0.27.0->pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (3.10)
Requirement already satisfied: h11<0.15,>=0.13 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from httpcore==1.*->httpx<1,>=0.27.0->pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (0.14.0)
Requirement already satisfied: charset_normalizer<4,>=2 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from requests<3.0,>=2.26->poetry) (3.4.2)
Requirement already satisfied: distlib<1,>=0.3.7 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from virtualenv<21.0.0,>=20.26.6->poetry) (0.4.0)
Requirement already satisfied: decorator in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from ipython) (5.2.1)
Requirement already satisfied: jedi>=0.16 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from ipython) (0.19.2)
Requirement already satisfied: matplotlib-inline in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from ipython) (0.1.7)
Requirement already satisfied: pexpect>4.3 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from ipython) (4.9.0)
Requirement already satisfied: prompt_toolkit<3.1.0,>=3.0.41 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from ipython) (3.0.51)
Requirement already satisfied: pygments>=2.4.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from ipython) (2.19.2)
Requirement already satisfied: stack_data in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from ipython) (0.6.3)
Requirement already satisfied: traitlets>=5.13.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from ipython) (5.14.3)
Requirement already satisfied: wcwidth in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from prompt_toolkit<3.1.0,>=3.0.41->ipython) (0.2.13)
Requirement already satisfied: parso<0.9.0,>=0.8.4 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from jedi>=0.16->ipython) (0.8.4)
Requirement already satisfied: ptyprocess>=0.5 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from pexpect>4.3->ipython) (0.7.0)
Requirement already satisfied: cryptography>=2.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from SecretStorage>=3.2->keyring<26.0.0,>=25.1.0->poetry) (45.0.5)
Requirement already satisfied: cffi>=1.14 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from cryptography>=2.0->SecretStorage>=3.2->keyring<26.0.0,>=25.1.0->poetry) (1.17.1)
Requirement already satisfied: pycparser in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from cffi>=1.14->cryptography>=2.0->SecretStorage>=3.2->keyring<26.0.0,>=25.1.0->poetry) (2.22)
Requirement already satisfied: sniffio>=1.1 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from anyio->httpx<1,>=0.27.0->pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (1.3.1)
Requirement already satisfied: typing_extensions>=4.5 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from anyio->httpx<1,>=0.27.0->pbs-installer[download,install]<2026.0.0,>=2025.1.6->poetry) (4.14.1)
Requirement already satisfied: more-itertools in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from jaraco.classes->keyring<26.0.0,>=25.1.0->poetry) (10.7.0)
Requirement already satisfied: executing>=1.2.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from stack_data->ipython) (2.2.0)
Requirement already satisfied: asttokens>=2.1.0 in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from stack_data->ipython) (3.0.0)
Requirement already satisfied: pure-eval in /home/jules/.cache/pypoetry/virtualenvs/app-9TtSrW0h-py3.12/lib/python3.12/site-packages (from stack_data->ipython) (0.2.3)
--- 移交控制權至智慧安裝管理器 ---
python: can't open file '/tmp/pytest-of-swebot/pytest-1/test_final_run_sh_in_simulated0/content/WEB/poetry_manager.py': [Errno 2] No such file or directory
________________________ test_upload_transcription_file ________________________

    def test_upload_transcription_file():
        """測試檔案上傳與模擬轉寫功能。"""
        # 建立一個假的記憶體內檔案
        fake_audio_content = b"this is a fake audio file content"
        fake_file = ("test_audio.mp3", io.BytesIO(fake_audio_content), "audio/mpeg")

        response = client.post(
            "/api/transcribe/upload",
            files={"audio_file": fake_file}
        )

>       assert response.status_code == 200
E       assert 404 == 200
E        +  where 404 = <Response [404 Not Found]>.status_code

integrated_platform/tests/test_main.py:42: AssertionError
------------------------------ Captured log call -------------------------------
INFO     root:main.py:84 收到請求: POST /api/transcribe/upload
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/transcribe/upload "HTTP/1.1 404 Not Found"
=============================== warnings summary ===============================
integrated_platform/tests/e2e/test_full_system_flow.py:24
  /app/integrated_platform/tests/e2e/test_full_system_flow.py:24: PytestUnknownMarkWarning: Unknown pytest.mark.e2e - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.e2e

integrated_platform/tests/test_main.py:17
  /app/integrated_platform/tests/test_main.py:17: PytestUnknownMarkWarning: Unknown pytest.mark.smoke - is this a typo?  You can register custom marks to avoid this warning - for details, see https://docs.pytest.org/en/stable/how-to/mark.html
    @pytest.mark.smoke

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED integrated_platform/tests/ignition_test.py::test_import_all_modules - ...
FAILED integrated_platform/tests/test_final_deployment.py::test_final_run_sh_in_simulated_colab_env
FAILED integrated_platform/tests/test_main.py::test_upload_transcription_file
ERROR integrated_platform/tests/e2e/test_full_system_flow.py::test_full_transcription_flow
========= 3 failed, 2 passed, 2 warnings, 1 error in 122.62s (0:02:02) =========
