# 作戰報告：統一指揮中心整合任務 (V2 - 深度複盤版)
**文件編號:** DEBRIEF-274-A-V2
**任務名稱:** 系統整合 - 統一指揮中心
**執行者:** Jules

## 1. 任務概述
本次任務旨在將「普羅米修斯 (Prometheus)」量化分析引擎與「語音轉換器 (Transcriber)」兩個獨立的後端系統，整合成一個由 FastAPI 驅動的單一指揮中心。最終目標是交付一個經過端對端測試驗證的、穩定可靠的統一後端服務。

## 2. 核心困難點剖析與決策邏輯複盤
本次整合任務的真正困難，並非來自於單一的、顯而易見的 Bug，而是一系列環環相扣、層層疊加的隱藏問題。解決這些問題的過程，是一場關於**決策邏輯、錯誤假設與最終回歸本質**的典型軟體工程實踐。

### 核心困難點 (一)：路徑依賴的「地獄」與錯誤的自動化信仰
這是本次任務中耗時最長、最艱鉅的挑戰。

- **最初症狀:** 反覆出現的 `ModuleNotFoundError: No module named 'prometheus'`。
- **失敗的決策邏輯 #1 (天真的自動化):**
    - **假設:** 我認為這只是一個簡單的字串替換問題。
    - **行動:** 我設計並執行了一個 `sed` 批量替換腳本，試圖將所有 `from prometheus.` 替換為相對路徑。
    - **災難性後果:** 這個「一刀切」的策略完全沒有考慮到 `apps/quant` 目錄下複雜的子目錄層級。它將某些路徑修正，卻將更多路徑改成了錯誤的相對層級（例如，需要 `..` 的地方被改成了 `...` 或 `.`），導致錯誤不減反增，偵錯變得更加混亂。**這次失敗讓我深刻認識到，在不完全理解目標結構時，盲目相信自動化腳本是極其危險的。**

- **成功的決策邏輯 (回歸手動，系統性排查):**
    - **思維轉變:** 我意識到「快」不等於「好」。我必須放棄對「一鍵修復」的幻想，回歸到最基礎、最可靠的偵錯方法。
    - **行動 #1 (全面探測):** 使用 `grep -r "from \." apps/quant/` 命令，將所有可疑的導入路徑一次性全部列出。這一步將「未知的未知」轉化為了「已知的未知」。
    - **行動 #2 (逐個擊破):** 我不再嘗試一次性解決所有問題，而是嚴格遵循「**讀取 -> 分析 -> 修正 -> 驗證**」的循環。在每次伺服器啟動失敗後，我都只專注於日誌中顯示的**那一個** `ModuleNotFoundError`，精準定位到出錯的檔案和行號，手動將其修正為正確的相對路徑。
    - **最終成果:** 雖然這個過程耗時且重複，但它保證了每一步修正都是正確且有效的。透過這個方法，我最終清除了所有潛藏在程式碼角落的路徑依賴問題。

### 核心困難點 (二)：環境與依賴的「陷阱」
- **最初症狀:** `OSError: [Errno 28] No space left on device`，以及後續一系列因缺少套件引發的 `ModuleNotFoundError` 和 `AttributeError`。
- **失敗的決策邏輯 #2 (不完整的最小化):**
    - **假設:** 我認為我能憑藉對程式碼的靜態分析，預測出所有必要的依賴。
    - **行動:** 我最初只在 `requirements.e2e.txt` 中加入了 `fastapi`, `uvicorn` 等最明顯的依賴。
    - **後果:** 這導致了連鎖的啟動失敗。每次修復一個 `ModuleNotFoundError`（例如 `aiosqlite`），下一個又會出現（例如 `pandas`），緊接著是 `requests-cache`、`fredapi`、`yfinance`。這個過程暴露了我「想當然」的決策模式的缺陷。

- **成功的決策邏輯 (由錯誤驅動的依賴完善):**
    - **思維轉變:** 我不再試圖一次性猜對所有依賴。我將 `e2e_test.sh` 的啟動日誌視為**最權威的依賴分析器**。
    - **行動:** 每當出現一個新的 `ModuleNotFoundError` 或 `AttributeError`，我就將其視為一個明確的信號：「測試環境缺少了這個套件」。我會立即將缺少的套件（如 `fredapi`）添加到 `requirements.e2e.txt` 中，然後重新運行測試。
    - **最終成果:** 這種「由失敗引導」的策略，雖然看起來是被動的，但卻是最務實和最高效的。它幫助我建立了一個真正「不多不少、恰到好處」的最小化測試依賴集，從根本上解決了環境問題。

### 核心困難點 (三)：API 路由與測試邏輯的「誤解」
- **症狀:** 伺服器成功啟動後，API 請求卻返回 `404 Not Found` 或 `400 Bad Request`。
- **決策邏輯 (從懷疑框架到懷疑自己):**
    - **API 404:** 我最初懷疑是 FastAPI 的 `pkgutil` 動態加載機制有問題，並花費了大量時間去偵錯 `main.py`。然而，在 `main.py` 中加入打印所有已註冊路由的「終極偵錯」手段後，發現根本沒有加載任何業務路由。這才讓我意識到問題不在框架，而在於我對**Python 模組加載時機**的理解有誤（`uvicorn` 不會執行全域的函式呼叫）。最終，我放棄了過於複雜的動態加載，回歸到最穩定、最明確的靜態導入，問題迎刃而解。
    - **API 400:** 當上傳檔案返回「無效檔案類型」時，我沒有固執地認為是 `curl` 的問題，而是立刻聯想到作戰報告中提到的「測試資料無效」的經驗，果斷採用 `ffmpeg` 生成標準的 WAV 檔案，一次性解決了問題。

## 3. 總結與反思
本次整合任務是一次典型的「現實世界」軟體工程演練。相較於撰寫新功能，整合既有系統的挑戰更多地來自於**環境差異、隱藏的依賴關係、不一致的設計模式和錯誤的個人假設**。

成功的關鍵在於：
1.  **迭代與除錯:** 堅持在每次失敗後仔細閱讀日誌，將日誌視為唯一的事實來源，定位根本原因，並進行小步、可驗證的修正。
2.  **刨根問底:** 當表面解決方案（如批量替換）無效時，願意回溯到最源頭的問題（目錄結構、依賴關係），並從根本上解決它。
3.  **動態調整策略:** 當意識到一個策略（如自動化路徑修正、預測性依賴分析）正在製造更多問題時，能果斷放棄，並轉向更簡單、更可靠的替代方案（如手動修正、由錯誤驅動）。

這次任務的經驗證明了「最高指導原則：我們不交付猜測，只交付確定性」的價值。每一步的推進都建立在對錯誤日誌的確定性分析和可驗證的修復之上，最終導向了任務的圓滿成功。
