# 作戰報告：統一指揮中心整合任務
**文件編號:** DEBRIEF-274-A
**任務名稱:** 系統整合 - 統一指揮中心
**執行者:** Jules

## 1. 任務概述
本次任務旨在將「普羅米修斯 (Prometheus)」量化分析引擎與「語音轉換器 (Transcriber)」兩個獨立的後端系統，整合成一個由 FastAPI 驅動的單一指揮中心。核心目標是提供統一、穩定的 API，並確保兩大核心功能在整合後能被端對端測試完整驗證。

## 2. 核心挑戰與解決方案
在任務執行過程中，遭遇了一系列典型的、但在現實世界中極其常見的整合挑戰。本節詳細記錄了每個問題的分析過程與最終採用的解決方案。

### 挑戰 1：環境空間不足 (`No space left on device`)
- **初次徵兆:** 在執行 `e2e_test.sh` 中的 `pip install -r requirements.txt` 步驟時，系統拋出 `OSError: [Errno 28] No space left on device` 錯誤。
- **分析過程:**
    1.  **初步猜測:** 認為是 `pip` 的套件快取佔用了大量空間。
    2.  **行動與驗證:** 執行 `pip cache purge`，成功釋放了約 3.4 GB 的空間。這證明了某些下載的套件體積異常龐大。
    3.  **深入分析:** 再次安裝時，錯誤依舊，但錯誤訊息明確指向了 `torch` 和 `nvidia` 相關套件。意識到問題根源在於完整的 `requirements.txt` 包含了對測試環境不必要的大型機器學習函式庫。
- **最終解決方案:**
    1.  **建立最小依賴集:** 創建一個新的 `requirements.e2e.txt` 檔案，僅包含運行伺服器和模擬邏輯所必需的輕量級套件（如 `fastapi`, `uvicorn`, `pandas` 等）。
    2.  **修改測試腳本:** 更新 `e2e_test.sh`，使其安裝這個新的、精簡的 `requirements.e2e.txt`，從而徹底繞開了磁碟空間問題。

### 挑戰 2：大規模模組導入路徑錯誤 (`ModuleNotFoundError`)
- **初次徵兆:** 即使解決了空間問題，伺服器依然啟動失敗，日誌中充斥著 `ModuleNotFoundError: No module named 'prometheus'` 或 `No module named 'src'`。
- **分析過程:**
    1.  **問題定位:** 錯誤發生在從舊專案遷移過來的 `apps/quant` 和 `apps/transcriber` 模組中。這些模組的原始碼保留了舊的、基於 `prometheus` 或 `src` 的絕對導入路徑。
    2.  **失敗的嘗試:** 最初嘗試使用 `sed` 命令進行全局批量替換，但因為沒有充分考慮不同檔案在目錄結構中的深度，反而引入了大量錯誤的相對路徑（例如，`from ..` 被錯誤地替換為 `from ...`）。
- **最終解決方案:**
    1.  **放棄天真的自動化:** 承認批量替換的策略過於粗糙，轉而採用更可靠的手動修正。
    2.  **系統性偵錯:** 使用 `grep -r "from \." apps/quant/` 命令，一次性找出所有可疑的相對導入語句。
    3.  **迭代修正:** 逐一檢查 `grep` 的結果，根據每個檔案的實際位置，手動將其導入路徑修正為正確的相對層級。這個雖然繁瑣但極其可靠的過程，最終清除了所有路徑依賴問題。

### 挑戰 3：API 路由未找到 (`404 Not Found`)
- **初次徵兆:** 伺服器成功啟動後，`e2e_test.sh` 中的 `curl` 請求回報 `{"detail":"Not Found"}`。
- **分析過程:**
    1.  **錯誤的假設:** 最初以為是 `main.py` 中動態加載路由的 `pkgutil` 或 `importlib` 邏輯有問題。花費了大量時間在 `main.py` 中增加偵錯輸出、調整導入順序，但路由依然無法被註冊。
    2.  **真相大白:** 在一次偵錯中，查看了 `apps` 子目錄下的 `main.py`，發現路由的定義是 `@router.post("/api/quant/backtest")`。而 `APIRouter` 在創建時也定義了 `prefix="/api/quant"`。這導致最終的路由變成了 `/api/quant/api/quant/backtest`，造成路徑重複。
- **最終解決方案:**
    1.  **統一路由定義:** 修改所有 `apps` 子目錄下的 `main.py`，將路由定義中的絕對路徑移除，只保留相對部分（例如，`@router.post("/backtest")`），將路徑前綴的管理完全交給 `APIRouter` 的 `prefix` 參數。

### 挑戰 4：測試資料無效 (`Invalid data found`)
- **初次徵兆:** API 路由正確後，檔案上傳請求返回 `400 Bad Request`，錯誤細節為「無效的檔案類型」。
- **分析過程:**
    1.  **問題假設:** `curl` 未能正確設定 `Content-Type`，或是 `fake_audio.mp3` 檔案本身是空的或已損壞。
    2.  **方案設計:** 採用作戰報告中提到的經驗，使用 `ffmpeg` 工具在測試執行時動態生成一個標準、有效的 WAV 格式音訊檔案。
- **最終解決方案:**
    1.  **安裝工具:** 在測試腳本中加入 `sudo apt-get install -y ffmpeg`。
    2.  **生成音檔:** 使用 `ffmpeg -f lavfi -i anullsrc ...` 命令生成一個靜音 WAV 檔案。
    3.  **更新腳本:** 修改 `e2e_test.sh`，使其上傳新生成的 `test_audio.wav`，問題解決。

## 3. 總結與反思
本次整合任務的歷程，完美詮釋了軟體工程中一個不變的真理：**整合的複雜性主要來源於環境的差異和隱藏的依賴，而非程式碼邏輯本身。**

成功的關鍵在於：
1.  **確定性壓倒一切:** 當優雅的動態解決方案（如 `pkgutil`）失效時，果斷回退到最簡單、最明確的靜態導入方案，是確保項目成功的務實之舉。
2.  **迭代式偵錯:** 堅持「一次只解決一個問題」。在每次失敗後，都專注於日誌中最高優先級的錯誤，進行定位和修復，然後立即重新驗證。這個循環是穿越複雜問題迷霧的唯一路徑。
3.  **懷疑一切，包括自己:** 在偵錯過程中，必須不斷挑戰自己的假設。當我意識到自己對 `sed` 的掌握不足以應對複雜的路徑替換時，果斷轉向手動修復，避免了在錯誤的道路上越走越遠。

最終，透過這種嚴謹、系統化的方法，我們不僅完成了系統的整合，還建立了一套健壯、可靠的端對端測試流程，為「統一指揮中心」的未來發展奠定了堅實的基礎。
