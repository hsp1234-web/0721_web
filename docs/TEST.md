# 測試計畫與執行指南 v2.0

**文件作者：** Jules (AI 軟體工程師)
**最後更新：** 2025年7月27日

## 一、 核心理念：分層測試，快速失敗

為了最大化開發效率並確保程式碼品質，我們採用了一套分層的測試策略。此策略的核心是「快速失敗」——在流程的早期階段用最快的速度發現最簡單的錯誤，避免在後期的、耗時的測試中才發現問題。

所有測試任務都已整合到專案根目錄的 `Makefile` 中，提供了一個統一、簡潔的指令入口。

### **測試層級：**

1.  **L1: 靜態分析 (Linting)**
    -   **指令:** `make lint`
    -   **目標:** 以毫秒級的速度檢查所有程式碼的語法錯誤、未定義變數等。這是最快的檢查，也是每次修改後都應該執行的第一步。
    -   **工具:** `Ruff`

2.  **L2: 單元測試 (Unit Testing)**
    -   **指令:** `make test-unit`
    -   **目標:** 針對單一模組或函式的核心邏輯進行快速驗證。此層級的測試不應涉及網路、磁碟 I/O 或其他大型依賴，所有外部互動都應被「模擬」(Mock)。
    -   **工具:** `Pytest` (執行標記為 `@pytest.mark.unit` 的測試)

3.  **L3: 端到端測試 (End-to-End Testing)**
    -   **指令:** `make test-e2e`
    -   **目標:** 模擬真實的使用者啟動流程，從頭到尾驗證整個系統的整合情況。這個測試會實際下載程式碼、安裝依賴並啟動服務。
    -   **工具:** `scripts/smart_e2e_test.sh` (由 Pytest 觸發)

## 二、 如何執行測試

### **前置要求：**

-   一個標準的 Linux/macOS/WSL 環境。
-   Python 3.8+
-   `make` 指令

### **建議的開發流程：**

1.  修改完程式碼後，首先執行：
    ```bash
    make lint
    ```
2.  如果 `lint` 通過，接著執行單元測試：
    ```bash
    make test-unit
    ```
3.  在準備提交您的變更之前，執行完整的端到端測試：
    ```bash
    make test-e2e
    ```
    您還可以透過設定環境變數來運行「真實模式」的 E2E 測試，該模式會下載大型 AI 模型：
    ```bash
    TEST_MODE=real make test-e2e
    ```

## 三、 端到端測試詳解 (`smart_e2e_test.sh`)

新的 `smart_e2e_test.sh` 腳本是我們自動化測試流程的核心，它實現了以下關鍵特性：

1.  **UV 加速:** 所有 Python 依賴都透過 `uv` 進行安裝，速度極快。
2.  **完全隔離:** 每個測試階段（例如，`核心API`, `量化插件`）都會在一個獨立的、用後即焚的 `.venv_...` 虛擬環境中執行。
3.  **自動清理:** 無論測試成功或失敗，該階段的虛擬環境都會在結束時被**自動刪除**，極大地節省了磁碟空間，並確保了測試之間不會互相污染。

這個設計確保了我們的 CI/CD 流程既快速又可靠。
