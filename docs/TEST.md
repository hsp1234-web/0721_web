# 測試計畫與執行指南 (作戰藍圖 275-D)

**文件作者：** Jules (AI 軟體工程師)
**最後更新：** 2025年7月26日

## 一、 核心理念：UV 加速的隔離化、階段化測試

為了解決傳統測試流程中依賴混雜、環境污染、測試緩慢等痛點，我們引入了一套全新的、以 `uv` 為核心的智能端到端測試框架。此框架被固化在一個名為 `smart_e2e_test.sh` 的統一指揮腳本中。

### **核心優勢：**

1.  **極致速度：** 利用 `uv` 的高速特性，在幾秒內建立虛擬環境並安裝依賴。
2.  **絕對隔離：** 每個測試階段都在一個獨立的、用後即焚的虛擬環境中執行，杜絕了任何跨測試的環境污染。
3.  **資源感知：** 測試前會自動檢查磁碟空間，避免因資源不足導致的測試失敗。
4.  **階段化執行：** 將不同功能的測試（基礎、量化、語音轉錄）分開，可以單獨評估每個模組的健康狀況。
5.  **模式切換：** 提供 `mock` (模擬) 和 `real` (真實) 兩種測試模式，允許開發者在快速流程驗證和完整功能驗證之間輕鬆切換。
6.  **穩健性：** 內建 `pytest-timeout`，防止任何單一測試因卡死而阻塞整個 CI/CD 流程。

---

## 二、 如何執行測試：`smart_e2e_test.sh`

所有端到端測試都應透過根目錄下的 `smart_e2e_test.sh` 腳本來啟動。

### **前置要求：**

1.  **Bash 環境：** 一個標準的 Linux/macOS/WSL 環境。
2.  **Python 與 pip：** 腳本會用 `pip` 來自動安裝 `uv` (如果尚未安裝)。
3.  **網路連線：** 用於下載依賴套件。

### **基本用法：**

在專案的根目錄下，直接執行腳本：

```bash
bash smart_e2e_test.sh
```

預設情況下，這將以 `TEST_MODE=mock` (模擬模式) 運行所有測試階段。在模擬模式下，腳本會**跳過**大型依賴（如 `torch`）的下載和安裝，並執行快速的 API 路徑驗證，主要用於 CI/CD 環境中的快速反饋。

### **進階用法：真實模式 (Real Mode)**

如果你需要驗證包含大型 AI 模型在內的完整功能（例如，在部署前或修改了核心轉錄邏輯後），你可以透過設置環境變數 `TEST_MODE` 來啟用「真實模式」。

```bash
TEST_MODE=real bash smart_e2e_test.sh
```

**警告：**
*   真實模式會下載數 GB 的依賴檔案 (`torch`, `faster-whisper` 模型等)，請確保你有足夠的磁碟空間和良好的網路連線。
*   此模式下的測試執行時間會顯著延長。

---

## 三、 腳本核心邏輯解析

`smart_e2e_test.sh` 腳本的執行流程如下：

1.  **初始化：**
    *   檢查並自動安裝 `uv`。
    *   讀取 `TEST_MODE` 環境變數。

2.  **分階段測試循環：**
    腳本會依次執行以下每個階段，每個階段都是一個獨立的沙盒：

    *   **階段一：基礎服務測試**
        *   **目標：** 驗證核心 API 能否正常啟動與響應。
        *   **環境：** `.venv_base`
        *   **依賴：** `requirements/base.txt` + `requirements/test.txt`
        *   **動作：**
            1.  檢查磁碟空間。
            2.  `uv venv .venv_base` 建立環境。
            3.  `uv pip install ...` 安裝依賴。
            4.  `pytest ...` 執行基礎點火測試 (`ignition_test.py`)。
            5.  `rm -rf .venv_base` 徹底刪除環境。

    *   **階段二：量化分析測試**
        *   **(同上，但使用 `.venv_quant` 和額外的 `requirements/quant.txt`)**

    *   **階段三：語音轉錄測試**
        *   **目標：** 根據 `TEST_MODE` 決定測試策略。
        *   **環境：** `.venv_transcriber`
        *   **動作：**
            *   **如果 `TEST_MODE=mock` (預設):**
                1.  僅安裝 `base.txt` 和 `test.txt` 依賴。
                2.  用 `echo` 語句**模擬** `transcriber.txt` 的安裝過程。
                3.  執行一個快速的 API 驗證測試。
            *   **如果 `TEST_MODE=real`:**
                1.  安裝 `base.txt`, `test.txt`, **以及 `transcriber.txt`** 中的所有依賴。
                2.  執行完整的端到端流程測試 (`test_e2e_flow.py`)，該測試會實際處理音訊檔案。
            *   最後同樣徹底刪除 `.venv_transcriber` 環境。

## 四、 測試報告

每次執行 `smart_e2e_test.sh` 後，建議根據其輸出填寫一份 `docs/MISSION_DEBRIEFING.md` 文件，以記錄測試結果、遇到的問題和解決方案。這對於團隊協作和追蹤專案健康狀況至關重要。
