# 鳳凰之心專案：經驗教訓與決策日誌

本文檔旨在記錄在「鳳凰之心」專案開發和維護過程中所遇到的關鍵問題、採取的解決方案以及從中學到的寶貴經驗。

---

## 課題一：從「靈活」的依賴到「可預測」的環境

**日期**: 2025-07-30

### 1. 初始狀態與潛在風險

在專案的早期階段，為了快速迭代，我們的 `requirements.txt` 檔案採用了不指定版本的格式，例如：

```
fastapi
pandas
uvicorn
```

這種做法雖然在開發初期很方便，但隱藏著一個巨大的風險，這是一個典型的**技術債務**。我們在一次全面的程式碼審查中識別出這個問題。

**核心風險**：當任何一個第三方依賴庫（例如 `pandas`）發布一個包含**破壞性變更 (Breaking Change)** 的新版本時，我們的持續整合(CI)或部署流程會自動拉取這個最新版本。由於我們的程式碼是基於舊版本開發的，這幾乎肯定會導致應用程式在生產環境中意外崩潰。這種不確定性對於一個追求穩定性的系統是不可接受的。

### 2. 解決方案：全面鎖定依賴版本

為了解決這個問題，我們決定採納軟體工程中的最佳實踐：**為所有依賴項精確鎖定版本**。

我們採取的具體步驟如下：
1.  為 `apps/` 目錄下的每一個微服務（`quant`, `transcriber` 等）創建一個獨立的、乾淨的虛擬環境。
2.  在該環境中，使用 `uv pip install -r requirements.txt` 安裝其所有依賴。
3.  安裝成功後，立即執行 `uv pip freeze > requirements.txt` 命令。
4.  這個命令會將當前環境中所有套件（包括依賴的依賴）的**精確版本號**寫回到 `requirements.txt` 檔案中。

修改後的 `requirements.txt` 檔案看起來像這樣：
```
fastapi==0.116.1
pandas==2.3.1
uvicorn==0.35.0
...
```

**帶來的好處**：
- **可預測性**：無論何時、何地、由誰來部署，所建立的 Python 環境都是完全一致的。
- **穩定性**：杜絕了因上游依賴庫更新而導致的意外故障。
- **易於除錯**：如果出現問題，我們可以確信問題不是由環境變化引起的，從而縮小了除錯範圍。

---

## 課題二：Colab 環境的 URL 代理機制

### 1. 問題現象

在本地或標準伺服器（非 Colab 環境）上執行 `launch.py` 進行完整部署時，最終產生的儀表板 URL 是 `http://localhost:8005/`。開發者可能會困惑，因為這個 URL 在他們的本地瀏覽器中無法訪問到運行在伺服器上的服務。

### 2. 原因分析與澄清

這個現象是**完全符合預期的**，並且證明了我們的環境檢測邏輯是正確的。

- **`localhost` 的含義**：`localhost` 永遠指向當前執行程式的機器。在 Colab 中，Python 程式碼運行在 Google 的遠端伺服器上。
- **Colab 的解決方案**：Google Colab 提供了一個名為 `google.colab.kernel.proxyPort()` 的 JavaScript 函式。它可以為在遠端伺服器上運行的服務（例如我們的儀表板）生成一個**公開的、可從外部訪問的代理 URL**。
- **我們的實現**：`launch.py` 腳本中包含了以下智慧型判斷邏輯：
  ```python
  try:
      # 嘗試導入 google.colab 模組
      from google.colab.output import eval_js
      import google.colab

      # 判斷是否真的在 Colab Kernel 中運行
      if hasattr(google.colab, 'kernel') and google.colab.kernel:
          # 如果是，則呼叫代理函式獲取公開 URL
          final_url = eval_js(f"google.colab.kernel.proxyPort(8005)")
      else:
          # 如果不是（例如在標準伺服器上），則使用預設的本地 URL
          final_url = "http://localhost:8005/"
  except (ImportError, AttributeError):
      # 如果連 google.colab 模組都無法導入，說明肯定不在 Colab 環境
      final_url = "http://localhost:8005/"
  ```

**結論**：開發者無需擔心 `localhost` 的問題。只要專案是透過 `run/colab_runner.py` 在真實的 Colab 環境中啟動，系統就會自動提供一個穩定、可用的公開 URL。

---

## 課題三：引入多模式啟動器以提升開發效率

### 1. 需求

開發過程中存在不同的場景：有時需要快速驗證一個小改動，有時需要運行完整的測試，有時則需要部署整個應用。如果每次都執行完整的部署流程，會非常耗時。

### 2. 解決方案

我們在 `launch.py` 和 `run/colab_runner.py` 中引入了三種啟動模式：

1.  **自動自檢模式 (`SELF_CHECK_MODE=true`)**:
    *   **目的**：進行完整的系統健康檢查。
    *   **行為**：執行 `smart_e2e_test.py`，運行所有單元測試和整合測試，完成後自動退出。
    *   **適用場景**：程式碼合併前、新環境部署後的完整性驗證。

2.  **快速驗證模式 (`FAST_TEST_MODE=true`)**:
    *   **目的**：僅驗證核心啟動和通訊流程。
    *   **行為**：跳過所有依賴安裝和測試，模擬服務成功啟動。
    *   **適用場景**：前端開發、快速檢查 Colab 儀表板的 UI 變更。

3.  **完整部署模式 (預設)**:
    *   **目的**：啟動完整的應用程式。
    *   **行為**：安裝所有依賴，並啟動所有微服務。
    *   **適用場景**：手動測試、生產環境或提供給使用者進行實際操作。

這一改進極大地提升了開發和測試的靈活性與效率。
