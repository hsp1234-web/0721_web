# 鳳凰之心架構設計 v2.0

本文檔詳細描述了「鳳凰之心」專案的軟體架構、設計原則和核心組件。新版架構的核心是模組化、可擴展性和穩健性。

## 1. 設計哲學

- **關注點分離 (Separation of Concerns)**: 每個組件都有明確且單一的職責。
- **高內聚，低耦合**: 模組內部功能緊密相關，模組之間依賴性降至最低。
- **錯誤隔離**: 單一模組的失敗不應導致整個系統崩潰。
- **可擴展性 (Scalability)**: 新的功能模組可以輕鬆集成，而無需修改核心系統。
- **可維護性 (Maintainability)**: 清晰、一致的結構和編碼風格，使得理解、修改和除錯變得更加容易。

## 2. 高層架構圖

```
+--------------------------------------------------+
|      使用者 (透過 Colab 筆記本)                  |
+------------------------+-------------------------+
                         |
                         v
+--------------------------------------------------+
|      Colab 環境 / 本地開發環境                   |
|                                                  |
|  +--------------------------------------------+  |
|  |     啟動器 (launcher/src/main.py)          |  |
|  |  +---------------------------------------+ |  |
|  |  |           儀表板 (Rich UI)            | |  |
|  |  +---------------------------------------+ |  |
|  |  |    核心模組 (環境, 安裝, 程序管理)    | |  |
|  |  +---------------------------------------+ |  |
|  |  |     日誌資料庫 (SQLite)               | |  |
|  |  +------------------+--------------------+ |  |
|  |                     | 啟動                 |  |
|  |                     v                      |  |
|  +--------------------------------------------+  |
|                         |                        |
|  +----------------------v----------------------+  |
|  |     核心應用 (main_api.py) - FastAPI         |  |
|  |                                            |  |
|  |  +-----------------+  +------------------+  |  |
|  |  |   API 路由器     |  |   背景任務        |  |
|  |  +-----------------+  +------------------+  |  |
|  +--------------------------------------------+  |
+--------------------------------------------------+
```

## 3. 核心組件詳解

### 3.1. `launcher/` - 模組化啟動器

這是專案的全新入口點，取代了舊的單體啟動腳本。它被設計為一個獨立的 Python 應用程式。

- **`launcher/src/main.py`**: 啟動器的核心協調器。負責讀取設定、初始化所有子模組，並按照預定順序執行啟動流程。
- **`launcher/src/core/`**: 包含啟動器的所有核心業務邏輯。
    - `environment.py`: 負責檢查系統資源（磁碟、記憶體）。
    - `installer.py`: 負責下載程式碼、安裝依賴，並內建資源預先評估機制，避免因空間不足而崩潰。
    - `process_manager.py`: 負責在背景啟動和監控 FastAPI 主應用程式。
    - `log_database.py`: 負責將日誌歸檔到 SQLite 資料庫，並管理其大小。
- **`launcher/src/display/`**:
    - `dashboard.py`: 基於 `rich` 函式庫，提供一個美觀、即時更新的終端儀表板，顯示系統狀態、資源使用和日誌。
- **`launcher/config/settings.toml`**: 集中式的設定檔，允許使用者輕鬆配置所有啟動參數。
- **`launcher.ipynb`**: 在 Colab 中啟動專案的唯一入口點。它非常簡潔，僅負責準備設定檔並執行 `launcher/src/main.py`。

### 3.2. `main_api.py` - 核心應用

- **職責**: 這是基於 FastAPI 的核心 Web 伺服器。它現在更專注於提供 API 服務和執行背景任務。
- **生命週期管理**: 繼續使用 FastAPI 的 `lifespan` 事件來處理自身的初始化和清理任務。

### 3.3. `docs/` - 文件中心

- **職責**: 存放所有專案相關的說明文件。本文件 (`ARCHITECTURE.md`) 和 `Colab_Guide.md` 都會更新以反映新架構。

## 4. 啟動流程

1.  **使用者** 在 Colab 中打開 `launcher.ipynb` 並執行程式碼儲存格。
2.  **`launcher.ipynb`** 將使用者的設定寫入到 `launcher/config/settings.toml`。
3.  **`launcher.ipynb`** 執行 `python launcher/src/main.py` 命令。
4.  **`launcher/src/main.py`** 開始執行：
    a.  讀取 `settings.toml` 設定檔。
    b.  初始化 `LogDatabase` (如果已啟用)。
    c.  初始化並啟動 `Dashboard`，顯示即時 UI。
    d.  **[同步階段]** 依次執行：
        i.  環境檢查 (磁碟、記憶體)。
        ii. 核心依賴安裝。
        iii. 專案程式碼下載 (如果需要)。
        iv. 專案依賴安裝 (並在安裝前進行空間預檢)。
    e.  **[非同步階段]**
        i.  使用 `ProcessManager` 在背景啟動 `main_api.py`。
        ii. 監聽 `main_api.py` 的輸出並顯示在儀表板上。
    f.  獲取 Colab 分配的公開 URL 並顯示在儀表板上。
5.  **使用者** 點擊儀表板上的連結，即可在瀏覽器中開啟並使用 Web 應用。
6.  當使用者中斷程序時，`main.py` 的 `finally` 區塊會確保 `main_api.py` 子程序和資料庫連線都被優雅地關閉。
