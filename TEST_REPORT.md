# 測試與重構報告 (Phoenix Heart v8.1)

**文件作者：** Jules (AI 軟體工程師)
**最後更新：** 2025年7月28日
**狀態：** ✅ 所有測試通過

## 1. 任務目標

本次任務的核心目標是為「鳳凰之心」專案建立一個全面、穩健的自動化測試套件，並確保所有微服務（`quant` 和 `transcriber`）都能在隔離的環境中被獨立驗證，最終目標是讓 `scripts/launch.py --dashboard` 能夠在 Colab 環境中成功啟動並顯示一個功能齊全、測試狀態正確的儀表板。

## 2. 遇到的挑戰與解決過程

在達成目標的過程中，我們遇到了一系列環環相扣的複雜技術挑戰。以下是詳細的除錯與重構日誌：

### 挑戰一：`run_e2e_tests.sh` 的「大爆炸」測試模式

*   **問題描述**：初版的端對端測試腳本 `run_e2e_tests.sh` 將所有服務的依賴都安裝在同一個共享的虛擬環境中。這種模式雖然簡單，但極其脆弱，導致了後續一系列難以追蹤的問題。
*   **分析**：這種模式違反了微服務獨立性的核心原則。當 `pytest` 和 `TestClient` 試圖在一個程序中測試由另一個獨立子程序 (`subprocess.Popen`) 啟動的 FastAPI 應用時，`pytest` 的模擬和依賴注入機制（如 `mocker.patch` 和 `app.dependency_overrides`）完全無法跨越程序邊界，導致測試行為與預期完全不符。
*   **最終解決方案**：在您的關鍵指導下，我們做出了最正確的決定——**徹底拋棄共享環境的測試模式**。我建立了一個全新的、更優雅的測試執行器 `scripts/run_isolated_tests.py`，它以程式化的方式，為每一個微服務建立自己獨立的虛擬環境，並在其中執行針對性的測試。這從根本上解決了環境污染和測試互相干擾的問題。

### 挑戰二：神秘的 `TypeError: 'str' object is not callable`

*   **問題描述**：在 `transcriber` 服務的 API 測試中，一個被 `Depends()` 注入的函式依賴，在執行時頑固地變成了一個看似隨機的 UUID 字串，導致 `TypeError`。
*   **分析**：這個極其反常的行為是「大爆炸」測試模式的直接產物。由於 `TestClient` 和 `uvicorn` 運行的應用程式實例不是同一個，`dependency_overrides` 從未真正生效。FastAPI 在子程序中似乎產生了某種內部識別碼作為依賴的解析結果，而不是我們期望的模擬函式。
*   **最終解決方案**：切換到 `run_isolated_tests.py` 的隔離測試模式後，這個問題迎刃而解。在單一程序的隔離測試環境中，`TestClient` 和它測試的 `app` 物件位於同一個世界，`dependency_overrides` 能夠完美地攔截和覆寫依賴，`TypeError` 也隨之消失。

### 挑戰三：`ImportError: attempted relative import with no known parent package`

*   **問題描述**：在我們轉向更嚴格的隔離測試模式後，`pytest` 開始拋出導入錯誤，無法處理 `from ..main import app` 這類相對導入。
*   **分析**：這是因為 `pytest` 在執行時，預設並不知道專案的根目錄結構。當它在 `src/quant/tests` 目錄下執行時，它不認識 `src` 這個 "祖父級" 的套件。
*   **最終解決方案**：我採用了 `pytest` 官方推薦的最佳實踐：在專案的根目錄下建立一個 `pytest.ini` 設定檔，並在其中加入 `pythonpath = .`。這行設定明確地告訴 `pytest`：「請將專案根目錄作為 `PYTHONPATH` 的一部分」，從而讓所有相對導入都能被正確解析。

### 挑戰四：API 路由的雙重前綴問題

*   **問題描述**：`quant` 服務的所有 API 測試都回傳 404 Not Found。
*   **分析**：經過檢查，發現 `quant/main.py` 在 `app.include_router` 時設定了 `/api/v1` 前綴，同時在 `quant/api/v1/routes.py` 的 `APIRouter` 中又設定了 `/v1` 前綴，導致實際路徑變成了 `/api/v1/v1/...`。
*   **最終解決方案**：移除了 `routes.py` 中的多餘前綴，由主應用程式 `main.py` 統一管理版本前綴，解決了路徑錯誤的問題。

## 3. 最終交付成果

1.  **全新的隔離測試執行器 (`scripts/run_isolated_tests.py`)**: 一個穩健、可靠的 Python 腳本，成為專案品質保證的核心。
2.  **精簡的測試依賴 (`pytest.ini`)**: 透過官方設定檔解決了所有 Python 路徑問題。
3.  **100% 通過的測試套件**: `quant` 和 `transcriber` 兩個服務現在都有了可以獨立運行的、會真實失敗也會真實通過的單元/整合測試。
4.  **清晰的程式碼結構**: 專案內的導入路徑現在全部使用相對導入，增強了模組的內聚性和可移植性。
5.  **準確的文件**: `docs/TEST.md` 被更新，以反映新的測試策略。
6.  **一份詳細的報告 (本檔案)**: 記錄了我們的奮鬥與成功。

這次重構極大地提升了專案的工程品質，為未來的開發和維護工作奠定了堅實的基礎。
