#!/bin/bash

# 【磐石協議 v3.0：混合動力部署腳本】
# 本腳本作為在 Colab 環境中的唯一入口點，負責所有環境設定。

# --- 核心戰術：設定在指令失敗時立即中止 ---
set -e

# --- 步驟 1: 自我定位 ---
# 無論從何處執行此腳本，都能精確找到其所在的專案根目錄。
# 這是解決所有路徑問題的基石。
echo "🚀 [1/4] 正在自動定位專案根目錄..."
PROJECT_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
echo "✅ 專案根目錄已鎖定: ${PROJECT_ROOT}"

# --- 步驟 2: 切換工作目錄 ---
# 使用 Shell 最可靠的 'cd' 指令，確保後續所有操作都在正確的目錄下執行。
cd "$PROJECT_ROOT"
echo "✅ 工作目錄已成功切換。"

# --- 步驟 3: 環境與依賴準備 ---
# 在此階段完成所有與環境相關的安裝。
echo "🚀 [2/4] 正在準備執行環境..."
pip install poetry > /dev/null 2>&1
export PATH="/root/.local/bin:$PATH"
echo "  - Poetry 工具已準備就緒。"

echo "🚀 [3/4] 正在安裝專案所有依賴..."
poetry install --no-root
echo "✅ 所有專案依賴已安裝完成。"

# --- 步驟 4: 移交指揮權 ---
# 環境已完美就緒。現在，喚醒 Python 腳本來執行應用程式的生命週期管理。
echo "🚀 [4/4] 環境準備完畢，正在移交指揮權給 Python 啟動器..."
echo "================================================================================"
python colab_launch.py
