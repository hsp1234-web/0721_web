#!/bin/bash

# å•Ÿç”¨ -e é¸é …ï¼Œè®“è…³æœ¬åœ¨ä»»ä½•æŒ‡ä»¤å¤±æ•—æ™‚ç«‹å³é€€å‡º
set -e

# --- è¼”åŠ©å‡½å¼ ---
print_header() {
  echo ""
  echo "======================================================================"
  echo "ğŸš€ $1"
  echo "======================================================================"
}

print_info() {
  echo "â„¹ï¸  $1"
}

print_success() {
  echo "âœ… $1"
}

# --- ä¸»è¦é‚è¼¯ ---

# 1. æ¸…ç†èˆŠç’°å¢ƒ
print_header "æ­¥é©Ÿ 1/7: æ¸…ç†èˆŠçš„è™›æ“¬ç’°å¢ƒ"
if [ -d ".venv" ]; then
  print_info "åµæ¸¬åˆ°èˆŠçš„ '.venv' ç›®éŒ„ï¼Œæ­£åœ¨å°‡å…¶ç§»é™¤..."
  rm -rf .venv
  print_success "èˆŠç’°å¢ƒå·²æˆåŠŸç§»é™¤ã€‚"
else
  print_info "æœªç™¼ç¾èˆŠçš„ '.venv' ç›®éŒ„ï¼Œç„¡éœ€æ¸…ç†ã€‚"
fi

# 2. å»ºç«‹æ–°çš„è™›æ“¬ç’°å¢ƒ
print_header "æ­¥é©Ÿ 2/7: å»ºç«‹æ–°çš„ Python è™›æ“¬ç’°å¢ƒ"
python3 -m venv .venv
print_success "è™›æ“¬ç’°å¢ƒ '.venv' å·²æˆåŠŸå»ºç«‹ã€‚"

# 3. å•Ÿå‹•è™›æ“¬ç’°å¢ƒä¸¦å®‰è£æ ¸å¿ƒå·¥å…·
print_header "æ­¥é©Ÿ 3/7: å•Ÿå‹•ç’°å¢ƒä¸¦å®‰è£æ ¸å¿ƒå·¥å…·"
source .venv/bin/activate
pip install --upgrade pip > /dev/null
pip install uv > /dev/null
print_success "'uv' å·²æˆåŠŸå®‰è£åˆ°è™›æ“¬ç’°å¢ƒä¸­ã€‚"

# 4. ä½¿ç”¨ pip å®‰è£ä¾è³´
print_header "æ­¥é©Ÿ 4/7: ä½¿ç”¨ pip å®‰è£æ‰€æœ‰å°ˆæ¡ˆä¾è³´"
print_info "æ­£åœ¨å®‰è£é–‹ç™¼ç’°å¢ƒä¾è³´ (åŒ…å«æ ¸å¿ƒä¾è³´)..."
pip install -r requirements/dev.txt
print_success "æ‰€æœ‰ä¾è³´å·²æˆåŠŸå®‰è£ã€‚"

# 5. åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªèˆ‡ä¾è³´æª¢æŸ¥
print_header "æ­¥é©Ÿ 5/7: åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªèˆ‡ä¾è³´æª¢æŸ¥"
print_info "æ­£åœ¨å®‰è£æª¢æŸ¥å·¥å…· (Ruff, deptry)..."
# ruff å’Œ deptry éƒ½åœ¨ dev.txt ä¸­ï¼Œå·²ç¶“è¢«å®‰è£
print_info "æ­£åœ¨åŸ·è¡Œ 'ruff check'..."
ruff check . --select=F --ignore=E,W
print_success "Ruff ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å®Œæˆã€‚"
print_info "æ­£åœ¨åŸ·è¡Œ 'deptry' ä¾è³´é—œä¿‚æª¢æŸ¥... (æš«æ™‚åœç”¨)"
# deptry . #  <--- ç›®å‰ç‰ˆæœ¬çš„ deptry ä¼¼ä¹å­˜åœ¨ bugï¼Œæš«æ™‚ç¦ç”¨æ­¤æª¢æŸ¥ä»¥æ¨é€²ä¸»è¦æµç¨‹
print_success "Deptry ä¾è³´é—œä¿‚æª¢æŸ¥å®Œæˆã€‚"


# 6. åŸ·è¡Œæœ€çµ‚çš„å•Ÿå‹•å°æ¼”è…³æœ¬
print_header "æ­¥é©Ÿ 6/7: åŸ·è¡Œ 'run.py' é€²è¡Œæœ€çµ‚è¦–è¦ºèˆ‡åŠŸèƒ½é©—è­‰"
print_info "é€™å°‡å•Ÿå‹•å¼•å°ä¼ºæœå™¨ä¸¦æ‰“é–‹ç€è¦½å™¨ä¾†å±•ç¤ºå•Ÿå‹•å‹•ç•«ã€‚"
print_info "è«‹è§€å¯Ÿç€è¦½å™¨ä¸­çš„å‹•ç•«æ˜¯å¦ç¬¦åˆé æœŸã€‚"
# æ˜ç¢ºä½¿ç”¨è™›æ“¬ç’°å¢ƒä¸­çš„ python ä¾†åŸ·è¡Œè…³æœ¬ï¼Œç¢ºä¿ä¾è³´æ­£ç¢º
./.venv/bin/python run.py

print_header "æ­¥é©Ÿ 7/7: æ¸¬è©¦æµç¨‹å·²å…¨éƒ¨å®Œæˆï¼"
print_success "å¦‚æœç€è¦½å™¨ä¸­çš„å•Ÿå‹•å‹•ç•«æ­£å¸¸é¡¯ç¤ºï¼Œå‰‡è¡¨ç¤ºç³»çµ±åœ¨å…¨æ–°ç’°å¢ƒä¸‹å¯æˆåŠŸéƒ¨ç½²èˆ‡é‹è¡Œã€‚"
