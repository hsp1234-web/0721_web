# 鳳凰之心作戰平台 v2.0.0 架構說明文件

## 呈報對象： 指揮官
## 報告日期： 2025 年 7 月 23 日
## 版本號： v2.0.0 最終架構共識

---

## I. 前言

本文件旨在全面總結鳳凰之心作戰平台在 Google Colab 環境中，從初期問題診斷到最終架構演進的完整歷程。報告將詳細闡述我們所面臨的挑戰、採取的技術方案，以及 **v2.0.0「獨立戰情室」** 架構如何從根本上提升系統在資源受限環境下的穩定性、健壯性，並確保日誌顯示的即時性與絕對可靠性。

---

## II. 設計哲學：前端為啟動器，後端為總指揮

傳統上，Colab 儲存格可能包含大量程式碼，負責環境設定、依賴安裝、邏輯執行等多個環節。然而，這種設計在資源受限且行為特殊的 Colab 環境中，已被證實極易導致問題叢生，例如日誌消失、啟動不穩定等。

我們的 **v2.0.0 設計哲學**是：

-   **前端 (Colab 儲存格)**： 僅作為一個輕量、直觀的**「啟動器」**。其唯一職責是收集用戶輸入、準備最基礎的執行環境，然後將所有複雜的處理邏輯交由後端完成。
-   **後端 (`start_platform.py` 及其指揮的模組)**： 作為**「總指揮」**，負責所有複雜的作戰執行、資源管理、日誌記錄與顯示。它必須具備高度的韌性、解耦性與自動化能力。

這種職責分離的設計，能最大限度地減少前端的複雜性，將潛在問題點轉移到更易於管理和除錯的後端，從而提升整體系統的健壯性。

---

## III. v2.0.0 獨立戰情室架構

為了解決所有已知問題，特別是實現日誌顯示的絕對穩定性，我們制定了全新的「獨立戰情室」架構。其核心理念是**徹底解耦**和**優先保障日誌顯示功能**。

### A. 運作原理與模組職責

#### 1. 極簡化的 Colab 儲存格（前端）

-   **職責**：作為整個系統的「啟動按鈕」和「參數傳遞器」。
-   **實現**：
    -   提供完全中文化的參數設定介面。
    -   確保 Colab 環境的工作目錄正確。
    -   僅安裝 `psutil`，這是獨立日誌顯示進程啟動所需的最低要求。
    -   啟動單一的後端「總指揮」腳本 `integrated_platform/start_platform.py`，並將所有用戶設定的參數通過**命令列參數**傳遞給它。
-   **優勢**：儲存格程式碼極其簡潔、易讀、易於維護，且與後端邏輯完全分離，消除了因儲存格程式碼未同步而導致的問題。

#### 2. 「總指揮」腳本 (`integrated_platform/start_platform.py`)

-   **職責**：整個系統的單一入口點，負責所有複雜的啟動協調和生命週期管理。
-   **實現**：
    -   解析從 Colab 儲存格傳入的所有命令列參數。
    -   **最優先啟動**獨立的日誌顯示進程 `dashboard_process.py`，確保用戶一執行就能看到所有日誌。
    -   初始化並管理所有進程共用的 `logs.sqlite` 日誌資料庫。
    -   隨後，啟動主業務邏輯進程 `colab_bootstrap.py`。
    -   管理所有子進程的生命週期，包括監控它們的狀態和處理停止信號。
-   **優勢**：將複雜的啟動邏輯集中管理，與前端完全解耦，並確保日誌儀表板的最高優先級和即時可見性。

#### 3. 獨立的日誌顯示進程 (`integrated_platform/src/dashboard_process.py`)

-   **職責**：專門負責日誌的讀取和顯示，是我們的「獨立戰情室」。
-   **實現**：
    -   作為一個**完全獨立的 Python 進程**運行，其生命週期與主業務邏輯進程完全分離。
    -   持續從共用的 SQLite 資料庫讀取日誌，並利用 `psutil` 監控 CPU 和 RAM 使用率，將這些資訊即時更新到 Colab 的輸出介面。
-   **優勢**：**即使主業務邏輯進程因任何原因（例如 `poetry install` 被強制終止）崩潰或被終止，日誌儀表板也能持續運行**，提供不間斷的戰情資訊，這是健壯性的核心體現。

#### 4. 主業務邏輯進程 (`integrated_platform/src/colab_bootstrap.py`)

-   **職責**：其職責將變得更純粹，專注於後端環境的準備、後端服務的啟動和公開連結的建立。
-   **實現**：
    -   通過命令列參數接收所有必要的配置。
    -   所有內部路徑管理都將使用 `pathlib` 模組，以確保路徑操作的穩定性和可靠性。
-   **優勢**：職責單一，減少了其自身的複雜性，使其更穩定、更易於維護。

#### 5. 後端部署腳本 (`integrated_platform/run.sh`)

-   **職責**：保持其核心職責，即安裝 Poetry 依賴和啟動 FastAPI 服務。
-   **實現**：
    -   通過環境變數接收配置。
    -   使用 `poetry install --no-dev --no-ansi` 等參數，以減少資源消耗和輸出複雜度。
    -   包含穩健的健康檢查循環，確保 FastAPI 服務真正就緒。
-   **優勢**：依賴安裝更輕量、更穩定，服務啟動更可靠。

---

### B. 架構概覽與參數流動草圖

```mermaid
graph TD
    A[Colab 儲存格] -->|1. 參數 (顯示行數, 埠號等)| B(start_platform.py - 總指揮)
    B -->|2. 參數 (DB路徑, 顯示設定等)| C(dashboard_process.py - 獨立日誌顯示)
    B -->|3. 參數 (DB路徑, 埠號等)| D(colab_bootstrap.py - 主業務邏輯)
    D -->|4. 環境變數| E(run.sh - 後端部署腳本)
    E -->|5. 啟動服務| F(FastAPI 後端 - main.py)

    subgraph "共享資源"
        G[logs.sqlite 資料庫]
    end

    C -- 讀取日誌 --> G
    D -- 寫入日誌 --> G
    F -- 寫入日誌 --> G

    subgraph "使用者介面"
        H(Colab 輸出)
    end

    C -- 更新畫面 --> H
```

### C. 參數傳遞詳情

| 步驟 | 來源模組/環境 | 目標模組/腳本      | 傳遞參數 (範例)                                               | 傳遞方式     | 說明                                                                                             |
| :--- | :-------------- | :----------------- | :------------------------------------------------------------ | :----------- | :----------------------------------------------------------------------------------------------- |
| 1    | Colab 儲存格    | `start_platform.py`  | `LOG_DISPLAY_LINES`, `PROJECT_FOLDER_NAME`, `FASTAPI_PORT`      | 命令列參數 | Colab 儲存格通過 `subprocess.Popen` 啟動總指揮時，將用戶設定作為命令列引數傳遞。            |
| 2    | `start_platform.py` | `dashboard_process.py` | `db_path`, `display_lines`, `refresh_interval`, `app_version`, `stop_file` | 命令列參數 | 總指揮啟動獨立日誌進程時，傳遞顯示相關參數，並指定一個用於停止的信號檔案。              |
| 3    | `start_platform.py` | `colab_bootstrap.py` | `db_path`, `fastapi_port`, `app_version`                        | 命令列參數 | 總指揮啟動主業務邏輯進程時，傳遞日誌資料庫路徑和 FastAPI 相關參數。                       |
| 4    | `colab_bootstrap.py` | `run.sh`           | `UVICORN_PORT`, `APP_VERSION`, `POETRY_VIRTUALENVS_CREATE`      | 環境變數     | 主業務邏輯在執行 `run.sh` 子程序時，設定這些環境變數，`run.sh` 腳本會讀取它們來配置其行為。 |

---

## V. 優勢總結

這種**v2.0.0「獨立戰情室」**架構帶來了多重決定性優勢：

-   **絕對的日誌可見性**：即使後續所有步驟全部失敗，日誌儀表板依然存在，確保問題的可追溯性。
-   **高度模組化與解耦**：前端與後端職責分離，各模組職責單一，使得系統可以獨立開發、測試和維護。
-   **極致的系統健壯性**：將複雜且可能不穩定的邏輯下沉到後端，並由獨立的日誌系統提供即時反饋，大大降低了前端崩潰的風險。
-   **易於維護與更新**：未來後端邏輯的變動將無需修改前端儲存格，只需更新後端檔案即可。
-   **流暢的用戶體驗**：用戶一啟動就能看到日誌儀表板，全面掌握系統運行狀態。

透過這種設計，我們將 Colab 儲存格轉變為一個高效、穩定的**「作戰平台啟動器」**，將指揮權完全交給了後端，實現了最大化的後端處理與監控穩定性。
