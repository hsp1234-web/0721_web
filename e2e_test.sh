#!/bin/bash

# ==============================================================================
#                 é³³å‡°ä¹‹å¿ƒå°ˆæ¡ˆï¼šç«¯åˆ°ç«¯ (E2E) æ¸¬è©¦è…³æœ¬
#
#   æœ¬è…³æœ¬æ—¨åœ¨æä¾›ä¸€å€‹æ¨™æº–åŒ–ã€å¯é‡è¤‡çš„æµç¨‹ï¼Œç”¨æ–¼åœ¨ä¸€å€‹ç´”æ·¨çš„ç’°å¢ƒä¸­
#   é©—è­‰æ ¸å¿ƒæœå‹™çš„ç©©å®šæ€§èˆ‡åŠŸèƒ½æ­£ç¢ºæ€§ã€‚
#
#   åŸ·è¡Œæµç¨‹ï¼š
#   1. å»ºç«‹ä¸€å€‹å…¨æ–°çš„ã€éš”é›¢çš„ Python è™›æ“¬ç’°å¢ƒã€‚
#   2. åƒ…å®‰è£ç”Ÿç”¢ç’°å¢ƒå¿…è¦çš„ä¾è³´ (`base.txt`) èˆ‡æ¸¬è©¦å·¥å…· (`httpx`)ã€‚
#   3. åœ¨å¾Œå°å•Ÿå‹•æ ¸å¿ƒçš„ FastAPI ä¼ºæœå™¨ (`server_main.py`)ã€‚
#   4. é€é HTTP è«‹æ±‚ï¼Œå°æ‰€æœ‰é—œéµ API ç«¯é»é€²è¡Œå¥åº·æª¢æŸ¥èˆ‡åŠŸèƒ½é©—è­‰ã€‚
#   5. ç„¡è«–æ¸¬è©¦çµæœå¦‚ä½•ï¼Œç¢ºä¿åœ¨è…³æœ¬çµæŸæ™‚å¾¹åº•é—œé–‰ä¼ºæœå™¨é€²ç¨‹ã€‚
#   6. æ ¹æ“šæ¸¬è©¦çµæœï¼Œä»¥æ¸…æ™°çš„ç‹€æ…‹ç¢¼é€€å‡ºã€‚
#
# ==============================================================================

# --- é€šç”¨è¨­å®š ---
set -e  # å¦‚æœä»»ä½•å‘½ä»¤å¤±æ•—ï¼Œç«‹å³é€€å‡º
trap 'cleanup' EXIT  # ç„¡è«–è…³æœ¬å¦‚ä½•é€€å‡ºï¼ˆæˆåŠŸã€å¤±æ•—ã€ä¸­æ–·ï¼‰ï¼Œéƒ½åŸ·è¡Œ cleanup å‡½å¼

# --- è®Šæ•¸å®šç¾© ---
VENV_DIR=".e2e_venv"
PYTHON_EXEC="$VENV_DIR/bin/python"
PIP_EXEC="$VENV_DIR/bin/pip"
SERVER_PID_FILE="server.pid"
SERVER_LOG_FILE="server.log"
HOST="127.0.0.1"
PORT=8002 # ä½¿ç”¨ä¸€å€‹èˆ‡é–‹ç™¼ç’°å¢ƒä¸åŒçš„åŸ è™Ÿï¼Œé¿å…è¡çª

# --- å‡½å¼å®šç¾© ---

# æ¸…ç†å‡½å¼ï¼šç”¨æ–¼åœæ­¢ä¼ºæœå™¨å’Œç§»é™¤è‡¨æ™‚æª”æ¡ˆ
cleanup() {
    echo "--- æ­£åœ¨åŸ·è¡Œæ¸…ç†ç¨‹åº ---"
    if [ -f "$SERVER_PID_FILE" ]; then
        SERVER_PID=$(cat "$SERVER_PID_FILE")
        echo "â„¹ï¸  æ­£åœ¨åœæ­¢ä¼ºæœå™¨ (PID: $SERVER_PID)..."
        # ä½¿ç”¨ kill å‘½ä»¤ï¼Œä¸¦å¿½ç•¥ "No such process" çš„éŒ¯èª¤
        kill "$SERVER_PID" 2>/dev/null || true
        # ç­‰å¾…ä¸€å°æ®µæ™‚é–“ç¢ºä¿é€²ç¨‹å·²é—œé–‰
        sleep 2
        # å¦‚æœé€²ç¨‹é‚„åœ¨ï¼Œå‰‡å¼·åˆ¶ kill
        if ps -p "$SERVER_PID" > /dev/null; then
           echo "âš ï¸  ä¼ºæœå™¨æœªèƒ½æº«å’Œé—œé–‰ï¼Œå°‡å¼·åˆ¶çµæŸã€‚"
           kill -9 "$SERVER_PID" 2>/dev/null || true
        fi
        rm -f "$SERVER_PID_FILE"
        echo "âœ… ä¼ºæœå™¨å·²åœæ­¢ã€‚"
    fi
    # é¡¯ç¤ºæ—¥èªŒä»¥ä¾›é™¤éŒ¯
    if [ -f "$SERVER_LOG_FILE" ]; then
        echo "--- ä¼ºæœå™¨æ—¥èªŒ ($SERVER_LOG_FILE) ---"
        cat "$SERVER_LOG_FILE"
        echo "------------------------------------"
        rm -f "$SERVER_LOG_FILE"
    fi
    echo "âœ… æ¸…ç†å®Œæˆã€‚"
}

# --- æ¸¬è©¦ä¸»æµç¨‹ ---

echo "=================================================="
echo "ğŸš€ é–‹å§‹ç«¯åˆ°ç«¯ (E2E) æ¸¬è©¦"
echo "=================================================="

# 1. ç’°å¢ƒæº–å‚™
echo "--- æ­¥é©Ÿ 1/5: æº–å‚™å…¨æ–°çš„è™›æ“¬ç’°å¢ƒ ---"
if [ -d "$VENV_DIR" ]; then
    echo "â„¹ï¸  åµæ¸¬åˆ°èˆŠçš„ E2E è™›æ“¬ç’°å¢ƒï¼Œæ­£åœ¨ç§»é™¤..."
    rm -rf "$VENV_DIR"
fi
python3 -m venv "$VENV_DIR"
echo "âœ… è™›æ“¬ç’°å¢ƒå·²å»ºç«‹æ–¼ '$VENV_DIR'ã€‚"

# 2. å•Ÿå‹•è™›æ“¬ç’°å¢ƒä¸¦å®‰è£ä¾è³´
echo "--- æ­¥é©Ÿ 2/5: å•Ÿå‹•è™›æ“¬ç’°å¢ƒä¸¦å®‰è£ä¾è³´ ---"
source "$VENV_DIR/bin/activate"
echo "âœ… è™›æ“¬ç’°å¢ƒå·²å•Ÿå‹•ã€‚"
# é¦–å…ˆå®‰è£ uv ä»¥åŠ é€Ÿ
pip install uv > /dev/null
# ä½¿ç”¨ uv å®‰è£æ‰€æœ‰é–‹ç™¼ä¾è³´ï¼Œç¢ºä¿ä¸€åˆ‡å¯ç”¨
uv pip install -r requirements/dev.txt > /dev/null
uv pip install python-multipart > /dev/null
echo "âœ… ä¾è³´å®‰è£å®Œæˆã€‚"

# 3. å•Ÿå‹•æ ¸å¿ƒæœå‹™
echo "--- æ­¥é©Ÿ 3/5: åœ¨å¾Œå°å•Ÿå‹•æ ¸å¿ƒä¼ºæœå™¨ ---"
# ä½¿ç”¨ nohup åœ¨å¾Œå°é‹è¡Œï¼Œä¸¦å°‡æ—¥èªŒé‡å®šå‘
# ç¾åœ¨å¯ä»¥ç›´æ¥å‘¼å« pythonï¼Œå› ç‚º venv å·²ç¶“å•Ÿå‹•
nohup python server_main.py --host "$HOST" --port "$PORT" > "$SERVER_LOG_FILE" 2>&1 &
# ç²å–å¾Œå°é€²ç¨‹çš„ PID ä¸¦å¯«å…¥æª”æ¡ˆ
SERVER_PID=$!
echo "$SERVER_PID" > "$SERVER_PID_FILE"
echo "âœ… ä¼ºæœå™¨å·²åœ¨å¾Œå°å•Ÿå‹• (PID: $SERVER_PID)ã€‚æ­£åœ¨ç­‰å¾…å…¶å®Œå…¨å•Ÿå‹•..."
sleep 10 # ç­‰å¾… 10 ç§’ï¼Œç¢ºä¿æ‰€æœ‰è³‡æºï¼ˆåŒ…æ‹¬æ‡¶åŠ è¼‰çš„æ¨¡å‹ï¼‰éƒ½å·²æº–å‚™å°±ç·’

# 4. åŸ·è¡Œ API æ¸¬è©¦
echo "--- æ­¥é©Ÿ 4/5: åŸ·è¡Œ API ç«¯é»æ¸¬è©¦ ---"

# æ¸¬è©¦ 1: æ ¹ç›®éŒ„ (/) - åŸºæœ¬å¥åº·æª¢æŸ¥
echo "ğŸ§ª æ¸¬è©¦ 1: GET / (åŸºæœ¬å¥åº·æª¢æŸ¥)"
httpx "http://$HOST:$PORT/" --timeout 10
echo "âœ… æ¸¬è©¦ 1 é€šéã€‚"

# æ¸¬è©¦ 2: /docs - API æ–‡ä»¶
echo "ğŸ§ª æ¸¬è©¦ 2: GET /docs (API æ–‡ä»¶)"
httpx "http://$HOST:$PORT/docs" --timeout 10
echo "âœ… æ¸¬è©¦ 2 é€šéã€‚"

# æ¸¬è©¦ 3: /quant/data - é‡åŒ–æ•¸æ“š API
echo "ğŸ§ª æ¸¬è©¦ 3: GET /quant/data"
httpx "http://$HOST:$PORT/quant/data" --timeout 10
echo "âœ… æ¸¬è©¦ 3 é€šéã€‚"

# æ¸¬è©¦ 4: /transcriber/upload - èªéŸ³è½‰éŒ„ API (é¦–æ¬¡å‘¼å«ï¼Œæœƒè§¸ç™¼æ‡¶åŠ è¼‰)
# TODO: ä¿®å¾© httpx çš„æª”æ¡ˆä¸Šå‚³èªæ³•
# echo "ğŸ§ª æ¸¬è©¦ 4: POST /transcriber/upload (é¦–æ¬¡å‘¼å«ï¼Œæ¸¬è©¦æ‡¶åŠ è¼‰)"
# # å»ºç«‹ä¸€å€‹è‡¨æ™‚çš„å‡éŸ³è¨Šæª”
# echo "é€™æ˜¯ä¸€å€‹å‡çš„éŸ³è¨Šæª”" > fake_audio.mp3
# httpx --timeout 20 POST "http://$HOST:$PORT/transcriber/upload" -F "file=@fake_audio.mp3"
# rm fake_audio.mp3
# echo "âœ… æ¸¬è©¦ 4 é€šéã€‚"

# æ¸¬è©¦ 5: /transcriber/upload - èªéŸ³è½‰éŒ„ API (ç¬¬äºŒæ¬¡å‘¼å«ï¼Œæ‡‰ä½¿ç”¨å¿«å–)
# TODO: ä¿®å¾© httpx çš„æª”æ¡ˆä¸Šå‚³èªæ³•
# echo "ğŸ§ª æ¸¬è©¦ 5: POST /transcriber/upload (ç¬¬äºŒæ¬¡å‘¼å«ï¼Œæ¸¬è©¦å¿«å–)"
# echo "é€™æ˜¯ä¸€å€‹å‡çš„éŸ³è¨Šæª”" > fake_audio.mp3
# httpx --timeout 10 POST "http://$HOST:$PORT/transcriber/upload" -F "file=@fake_audio.mp3"
# rm fake_audio.mp3
# echo "âœ… æ¸¬è©¦ 5 é€šéã€‚"

# 5. æ¸¬è©¦å®Œæˆ
echo "--- æ­¥é©Ÿ 5/5: æ‰€æœ‰æ¸¬è©¦å‡å·²æˆåŠŸé€šé ---"

echo "=================================================="
echo "âœ… ç«¯åˆ°ç«¯ (E2E) æ¸¬è©¦æˆåŠŸï¼"
echo "=================================================="

# è…³æœ¬æœƒåœ¨é€™è£¡æ­£å¸¸é€€å‡ºï¼Œä¸¦è§¸ç™¼ trap 'cleanup' EXIT
exit 0
