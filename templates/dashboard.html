<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鳳凰之心 - 啟動序列</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #131314; --color-panel-bg: #1e1f20; --color-border: #3c4043;
            --color-text: #e8eaed; --color-dim: #9aa0a6; --color-header: #8ab4f8;
            --color-ok: #34a853; --color-warn: #fbbc04; --color-error: #ea4335;
            --color-info: #4285f4; --color-battle: #8ab4f8;
            --font-mono: 'Fira Code', 'Courier New', monospace; --font-sans: 'Noto Sans TC', sans-serif;
            --base-font-size: 15px; --line-height: 1.8;
        }
        html, body { height: 100%; margin: 0; overflow: hidden; box-sizing: border-box; }
        body {
            background-color: var(--color-bg); color: var(--color-text); font-family: var(--font-mono);
            font-size: var(--base-font-size); line-height: var(--line-height); display: flex; flex-direction: column;
        }
        .ok { color: var(--color-ok); } .warn { color: var(--color-warn); } .error { color: var(--color-error); }
        .info { color: var(--color-info); } .battle { color: var(--color-battle); } .header { color: var(--color-header); }
        .dim { color: var(--color-dim); } .highlight { color: #ffffff; font-weight: bold; }
        pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
        .hidden { display: none !important; }
        #boot-screen { padding: 20px; flex-grow: 1; overflow-y: auto; }
        .progress-bar-container { display: flex; align-items: center; gap: 10px; }
        .progress-bar-container .label { min-width: 220px; }
        #dashboard { display: flex; flex-direction: column; height: 100%; }
        #top-panel { padding: 15px 20px; border-bottom: 1px solid var(--color-border); background-color: var(--color-panel-bg); display: flex; flex-wrap: wrap; gap: 20px 30px; align-items: flex-start; flex-shrink: 0; }
        .panel-section { flex: 1; min-width: 280px; }
        .panel-title { font-family: var(--font-sans); font-weight: bold; color: var(--color-header); margin-bottom: 10px; }
        .service-item { display: flex; align-items: center; margin-bottom: 5px; }
        .service-icon { min-width: 2.2em; }
        .app-button { background-color: var(--color-battle); color: var(--color-bg); border: none; border-radius: 5px; padding: 10px 15px; font-family: var(--font-sans); font-weight: bold; font-size: 1em; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; }
        .app-button:hover { background-color: #a8c7fa; }
        #main-stream-container { flex-grow: 1; overflow-y: auto; padding: 10px 20px 60px 20px; }
        .stream-item { margin-bottom: 15px; word-wrap: break-word; overflow-wrap: break-word; }
        .stream-meta { display: flex; gap: 15px; align-items: center; }
        .stream-icon { min-width: 2em; }
        .stream-ts { color: var(--color-dim); }
        .stream-level { font-weight: bold; min-width: 90px; }
        .stream-text-content { padding-left: calc(2em + 15px); margin-top: 5px; }
        .stream-block-content { margin-top: 0.8em; padding-left: 0; padding-bottom: 0.8em; }
        .data-stream-table { border: 1px solid var(--color-border); padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; display: block; width: 100%; max-width: 100%; box-sizing: border-box; margin: 0; }
        .ds-row { display: flex; flex-wrap: wrap; }
        .ds-cell { flex: 1; padding: 2px 10px; border-bottom: 1px solid var(--color-border); min-width: 80px; word-wrap: break-word; overflow-wrap: break-word; }
        .ds-row:last-child .ds-cell { border-bottom: none; }
        .ds-header .ds-cell { font-weight: bold; color: var(--color-header); }
        .ds-separator .ds-cell { padding: 0; height: 1px; background: var(--color-border); flex-basis: 100%; }
        #status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--color-panel-bg); padding: 8px 20px; border-top: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; font-size: 14px; z-index: 10; box-sizing: border-box; }
        .status-group { display: flex; gap: 25px; }
        @media (max-width: 767px) {
            body { font-size: 13px; line-height: 1.6; }
            #top-panel { flex-direction: column; padding: 10px 15px; gap: 15px; }
            .panel-section { min-width: auto; width: 100%; }
            #main-stream-container { padding: 10px 15px 60px 15px; }
            .stream-meta { flex-direction: column; align-items: flex-start; gap: 5px; }
            .stream-icon, .stream-level { min-width: auto; }
            .stream-text-content { padding-left: 0; }
            .stream-block-content { margin-top: 0.5em; padding-bottom: 0.5em; }
            .data-stream-table .ds-cell, .ds-row { flex-direction: column; }
            .ds-header .ds-cell { border-bottom: none; }
            .ds-separator .ds-cell { display: none; }
            #status-bar { padding: 5px 15px; font-size: 12px; flex-direction: column; gap: 5px; align-items: flex-start; }
            .status-group { gap: 10px; }
        }
    </style>
</head>
<body>

    <div id="boot-screen"></div>

    <div id="dashboard" class="hidden">
        <div id="top-panel">
            <div class="panel-section">
                <div class="panel-title">⚙️ 即時資源監控</div>
                <pre id="ascii-stats"></pre>
            </div>
            <div class="panel-section">
                <div class="panel-title">🌐 核心服務狀態</div>
                <div id="service-status"></div>
            </div>
            <div class="panel-section">
                <div class="panel-title">🚀 應用程式入口</div>
                <button class="app-button" onclick="alert('模擬跳轉至 Web 應用程式！')">進入鳳凰之心主介面</button>
            </div>
        </div>
        <div id="main-stream-container"></div>
        <div id="status-bar"></div>
    </div>

<script>
// ==================================================================
// 鳳凰之心 v14.0 - 前端事件驅動渲染器
// ==================================================================
const bootScreen = document.getElementById('boot-screen');
const dashboard = document.getElementById('dashboard');
const progressBars = {}; // 用於儲存進度條的 DOM 元素

function getWebSocketURI(path) {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    return `${protocol}//${window.location.host}${path}`;
}

// --- 渲染函式 ---

function renderBootStep(payload) {
    const line = document.createElement('pre');
    line.innerHTML = `<span class="${payload.type || ''}">${payload.text}</span>`;
    bootScreen.appendChild(line);
    bootScreen.scrollTop = bootScreen.scrollHeight;
}

function renderProgressBarStart(payload) {
    const { name, size } = payload;
    const line = document.createElement('div');
    line.className = 'progress-bar-container';

    const text = document.createElement('span');
    text.className = 'label';
    text.textContent = `⏳ 安裝中: ${name.padEnd(12, ' ')}`;

    const progressBar = document.createElement('pre');
    progressBar.className = 'dim';
    progressBar.textContent = `[${'░'.repeat(10)}] 0% (${size})`;

    line.appendChild(text);
    line.appendChild(progressBar);
    bootScreen.appendChild(line);

    progressBars[name] = { text, progressBar, size };
}

function renderProgressBarUpdate(payload) {
    const { name, progress } = payload;
    const bar = progressBars[name];
    if (!bar) return;

    const p = Math.min(100, Math.max(0, progress));
    const filledCount = Math.round(p / 10);
    const emptyCount = 10 - filledCount;
    const filled = '█'.repeat(filledCount);
    const empty = '░'.repeat(emptyCount);

    bar.progressBar.textContent = `[${filled}${empty}] ${p}% (${bar.size})`;

    if (p >= 100) {
        bar.text.innerHTML = `✅ <span class="ok">已安裝: ${name.padEnd(12, ' ')}</span>`;
    }
}

function renderBootTable(payload) {
    const { title, rows } = payload;
    const table = document.createElement('div');
    table.className = 'data-stream-table';

    let content = `<div class="ds-row ds-header"><div class="ds-cell">${title}</div></div>`;
    content += `<div class="ds-row ds-separator"><div class="ds-cell"></div></div>`;

    rows.forEach(rowData => {
        content += `<div class="ds-row">`;
        rowData.forEach(cellData => {
            content += `<div class="ds-cell">${cellData}</div>`;
        });
        content += `</div>`;
    });

    table.innerHTML = content;
    bootScreen.appendChild(table);
    bootScreen.scrollTop = bootScreen.scrollHeight;
}

function transitionToMainDashboard() {
    bootScreen.classList.add('hidden');
    dashboard.classList.remove('hidden');
    // 在這裡可以啟動主儀表板的 WebSocket 連線
    // connectDashboardSocket();
    alert("啟動完成，準備切換到主儀表板！");
}

// --- WebSocket 連線邏輯 ---

function connectBootServer() {
    const ws = new WebSocket(getWebSocketURI('/ws/boot'));

    ws.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            switch (data.event_type) {
                case 'BOOT_STEP':
                    renderBootStep(data.payload);
                    break;
                case 'BOOT_PROGRESS_START':
                    renderProgressBarStart(data.payload);
                    break;
                case 'BOOT_PROGRESS_UPDATE':
                    renderProgressBarUpdate(data.payload);
                    break;
                case 'BOOT_TABLE':
                    renderBootTable(data.payload);
                    break;
                case 'BOOT_COMPLETE':
                    ws.close();
                    transitionToMainDashboard();
                    break;
                default:
                    console.warn("收到未知的啟動事件:", data);
            }
        } catch (e) {
            console.error("處理啟動事件時發生錯誤:", e);
        }
    };

    ws.onopen = function() {
        console.log("✅ 連線到引導伺服器成功。");
    };

    ws.onclose = function() {
        console.log("ℹ️ 與引導伺服器的連線已關閉。");
    };

    ws.onerror = function(error) {
        console.error("❌ 引導伺服器連線錯誤:", error);
        renderBootStep({ text: "❌ 引導伺服器連線失敗。請檢查後端日誌。", type: 'error' });
    };
}

// --- 程式進入點 ---
connectBootServer();

</script>
</body>
</html>
