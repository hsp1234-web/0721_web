<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é³³å‡°ä¹‹å¿ƒ - æŒ‡æ®ä¸­å¿ƒ</title>
    <!-- The entire page content will be dynamically generated by the backend -->
</head>
<body>
    <!-- This div is the root for our backend-driven UI -->
    <div id="phoenix-root"></div>

    <script>
        // This script block is the core of our backend-driven frontend.
        // It establishes a WebSocket connection and executes commands received from the server.

        const rootElement = document.getElementById('phoenix-root');
        let ws;

        function connect() {
            // Use wss:// for secure connections (like in Colab), otherwise ws://
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function(event) {
                console.log("âœ… [Phoenix] WebSocket connection established.");
                rootElement.innerHTML = '<p style="color: #34a853;">âœ… æŒ‡æ®ä¸­å¿ƒé€£ç·šæˆåŠŸ... æ­£åœ¨ç­‰å¾…å¾Œç«¯æŒ‡ä»¤...</p>';
                // Inform the backend that the frontend is ready to receive initialization commands.
                ws.send(JSON.stringify({ type: "FRONTEND_READY" }));
            };

            ws.onmessage = function(event) {
                // The backend sends a JSON object containing the JavaScript to execute.
                try {
                    const payload = JSON.parse(event.data);
                    if (payload.action === 'execute_js') {
                        // Use new Function() for safer execution than eval().
                        // It runs the code in its own scope.
                        new Function(payload.js_code)();
                    } else if (payload.action === 'set_html') {
                        // Allows the backend to completely replace the root element's HTML.
                        rootElement.innerHTML = payload.html;
                    }
                } catch (e) {
                    console.error("âŒ [Phoenix] Error processing command from backend:", e);
                    console.error("Received data:", event.data);
                }
            };

            ws.onclose = function(event) {
                console.warn("ğŸŸ¡ [Phoenix] WebSocket connection closed. Attempting to reconnect in 5 seconds...");
                rootElement.innerHTML = '<p style="color: #fbbc04;">ğŸŸ¡ æŒ‡æ®ä¸­å¿ƒé€£ç·šä¸­æ–·ï¼Œ5ç§’å¾Œå°‡å˜—è©¦é‡æ–°é€£ç·š...</p>';
                setTimeout(connect, 5000); // Attempt to reconnect after 5 seconds.
            };

            ws.onerror = function(event) {
                console.error("âŒ [Phoenix] WebSocket error observed:", event);
                rootElement.innerHTML = '<p style="color: #ea4335;">âŒ æŒ‡æ®ä¸­å¿ƒé€£ç·šç™¼ç”ŸéŒ¯èª¤ã€‚</p>';
            };
        }

        // Initial connection attempt.
        connect();
    </script>
</body>
</html>
