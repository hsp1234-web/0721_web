# **專案整合總結報告**

**報告日期:** 2025年07月22日

**執行者:** Jules (AI 軟體工程師)

## **一、 任務目標**

本次任務旨在將【普羅米修斯之火】金融數據框架與【鳳凰專案】錄音轉寫服務進行整合。根據使用者指示，最終產出物為兩個整合後的程式碼檔案與一份總結報告，無需進行測試與依賴安裝。

## **二、 執行過程**

1.  **檔案結構整合:**
    *   將【鳳凰專案】的原始碼 (`src`)、靜態檔案 (`static`) 和測試案例 (`tests`)，全部遷移至【普羅米修斯之火】專案的相應目錄下。
    *   建立了 `src/prometheus/transcriber` 作為轉寫服務的新家。

2.  **命令列介面 (CLI) 整合:**
    *   將轉寫服務的啟動命令 (`run-server`)，作為一個新的子命令 `transcriber run-server`，成功整合進【普羅米修斯之火】的主命令列工具 `run.py` 中。

3.  **核心服務重構:**
    *   **設定管理:** 將轉寫服務的設定（如資料庫路徑、上傳目錄），統一納入【普羅米修斯之火】的 `config.yml` 設定檔中。
    *   **日誌系統:** 移除了轉寫服務原有的獨立日誌系統，並將其日誌記錄功能，切換為使用【普羅米修斯之火】的中央日誌管理器。

4.  **程式碼翻譯與風格統一:**
    *   對所有新整合的轉寫服務相關檔案，進行了全面的在地化處理，將所有註解、日誌訊息、API 文件等，從英文翻譯為繁體中文。
    *   統一了程式碼的排版與命名風格，使其與【普羅米修斯之火】專案保持一致。

5.  **最終程式碼整合:**
    *   根據使用者的最終指示，將兩個專案的核心業務邏輯，全部整合到 `integrated_logic.py` 檔案中。
    *   將兩個專案的所有測試邏輯，全部整合到 `integrated_tests.py` 檔案中。

## **三、 最終產出物**

*   `integrated_logic.py`: 包含兩個專案所有業務邏輯的單一檔案。
*   `integrated_tests.py`: 包含兩個專案所有測試邏輯的單一檔案。
*   `README.md`: 本總結報告。

## **四、 結論**

本次整合任務已按照使用者的最新要求完成。雖然因為未安裝依賴與執行測試，整合後的程式碼無法保證可直接運行，但已成功地將兩個獨立專案的業務邏輯和測試邏輯，合併到指定的檔案中，並完成了在地化與風格統一的工作。

---

# **【普羅米修斯之火】金融因子工程與模擬框架**

## **專案總覽**

【普羅米修斯之火】是一個自動化的金融數據工程框架，其核心使命是:
1.  **系統性地從多個數據源獲取原始金融數據。**
2.  **構建一個統一、穩健的「特徵儲存 (Feature Store)」，包含數百個經過驗證的金融因子。**
3.  **基於特徵儲存，訓練能夠模擬未來因子行為的「因子模擬器 (Factor Simulator)」。**

本框架旨在為量化研究、風險管理和投資組合優化提供一個堅實的、數據驅動的基礎。

## **核心架構**

我們最終確立的系統架構，圍繞著兩大核心概念：**統一數據模型**和**自動化特徵工廠**。

*   **統一數據模型**:
    *   **標準化協議**: 所有進入系統的數據，無論來源 (yfinance, FRED, ...)，都會被轉換為一個標準化的內部格式。
    *   **主鍵與 UPSERT**: 我們採用「資產代號 + 日期」作為唯一主鍵，並實施「UPSERT」 (Update or Insert) 策略，從根本上解決了數據重複、欄位不匹配和更新衝突的問題。
    *   **數據倉庫 (`DataWarehouse`)**: 所有標準化後的數據都儲存在一個由 DuckDB 支持的高性能數據倉庫中，為後續的因子計算提供了單一、可靠的數據來源。

*   **自動化特徵工廠**:
    *   我們的特徵工廠由一系列針對不同資產類別（如股票、加密貨幣、債券）的**專門化因子引擎**組成。
    *   每個引擎都負責計算其領域內的特定因子，確保了邏輯的清晰和可擴展性。
    *   所有引擎都從統一的 `DataWarehouse` 讀取標準化數據，確保了計算的一致性。
    *   所有計算出的因子，都被儲存在一個獨立的 `factors.duckdb` 資料庫中，即我們的「特徵儲存」。

## **主要功能與使用方式**

本專案的所有功能，皆透過統一的 CLI 入口 `run.py` 進行操作。

1.  **構建特徵儲存 (`build-feature-store`)**
    此命令會啟動一個完整的數據處理管線，從獲取原始數據到計算並儲存所有因子。

    ```bash
    # 執行完整的特徵工程管線
    poetry run python run.py build-feature-store
    ```

2.  **運行因子模擬訓練 (`run-simulation-training`)**
    在特徵儲存構建完成後，此命令會針對指定的目標因子，訓練一個機器學習模型（因子模擬器）。

    ```bash
    # 針對 'T10Y2Y' 因子訓練一個模擬器
    poetry run python run.py run-simulation-training --target-factor T10Y2Y
    ```

## **作戰歷史 (Changelog)**

這份日誌記錄了【普羅米修斯之火】從一個充滿挑戰的初始原型，演進為一個穩定、可靠的數據工程框架的關鍵歷程。

### **v3.0 - 【架構簡化與清理】 (作戰計畫 142)**
*   **里程碑**: 實現了專案的架構簡化和程式碼清理。
*   **關鍵行動**:
    *   移除了多個過時的、與當前 v2.0 數據模型不兼容的檔案，包括 `OmniDataEngine`, `UniversalFactorEngine` 以及舊的 `p1`, `p2`, `p3` 數據管線。
    *   修正了所有因移除舊檔案而導致的模組導入錯誤 (`ModuleNotFoundError`)。
    *   修復了測試套件中的設定問題 (`pytest-asyncio`) 和邏輯錯誤，使所有測試 100% 通過。
    *   更新了專案文件 (`README.md`, `PROJECT_FILES_GLOSSARY.md`)，使其準確反映當前簡化後的架構。

### **v2.1 - 【系統穩定】 (作戰計畫 140)**
*   **里程碑**: 實現了專案的全面穩定。
*   **關鍵行動**:
    *   修復了在測試環境中因「幽靈引用」(dangling references) 導致的間歇性 `segmentation fault` 錯誤。
    *   通過對 `DBManager` 的實例化過程進行嚴格的生命週期管理，確保了資料庫連接在多進程環境中的安全關閉。
    *   完成了對整個測試套件的最終修復，確保所有測試 100% 可靠通過。

### **v2.0 - 【統一數據模型】 (作戰計畫 137-139)**
*   **里程碑**: 從根本上解決了數據庫的欄位不匹配、大小寫混亂和數據更新衝突問題。
*   **關鍵行動**:
    *   **實施「數據標準化協議」**: 設計並強制執行了一個統一的內部數據模型，確保所有從外部 API 獲取的數據在存入系統前，都被轉換為標準格式 (例如，所有欄位名小寫、統一的日期格式)。
    *   **引入「UPSERT」策略**: 重新設計了數據庫寫入邏輯，採用基於主鍵 (`symbol`, `date`) 的 UPSERT 操作，徹底消除了數據重複和更新衝突的風險。
    *   **建立 `DataWarehouse`**: 建立了一個中央數據倉庫，作為所有原始數據的唯一、權威的儲存，供下游的因子計算引擎使用。

### **v1.0 - 【鳳凰協議】 (作戰計畫 130-132)**
*   **里程碑**: 確立了「獨立 CLI 工人 + 持久化任務佇列」的次世代架構，解決了多進程並發寫入導致的「靜默失敗」和數據庫鎖定問題。
*   **背景**: 最初的設計試圖在一個複雜的多進程環境中共享資料庫連接和內存對象，導致了嚴重的穩定性問題。
*   **關鍵行動**:
    *   **架構重構**: 將系統分解為一系列獨立的、可通過命令列呼叫的「工人」 (workers)。
    *   **持久化任務佇列**: 引入了基於 SQLite 的持久化任務佇列，用於在不同的工人之間安全地傳遞任務。
    *   **簡化流程**: 每個工人都以「無狀態」的方式運行，從任務佇列中獲取任務，完成後將結果寫入獨立的檔案，完全避免了並發寫入衝突。
